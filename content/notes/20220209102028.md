+++
title = "ğŸ“Clojure API Client Development"
tags = ["WIKI"]
draft = false
+++

ä¸»ã«ã‚µãƒ¼ãƒ“ã‚¹ã®APIã‚’å©ãã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ãƒã‚¦ãƒã‚¦ã¾ã¨ã‚.

ref: [ğŸ“Clojure Web Development]({{< relref "20220118092453.md" >}}) ã‹ã‚‰åˆ†é›¢.

up: [ğŸ“‚Clojure]({{< relref "20220214041907.md" >}}) tags: [ğŸ·Clojure]({{< relref "20211111225741.md" >}}) refs: [ğŸ“Clojure with Twitter Development]({{< relref "20220307193727.md" >}})


## Clojure HTTP Client {#clojure-http-client}

ä¸»ãªã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«http-kitã¨clj-httpãŒã‚ã‚‹.

-   <https://github.com/http-kit/http-kit>
-   <https://github.com/dakrone/clj-http>

httpãƒªã‚¯ã‚¨ã‚¹ãƒˆã«é–¢ã—ã¦ã¯ã©ã¡ã‚‰ã‚‚åŒã˜ã“ã¨ãŒã§ãã‚‹. éåŒæœŸç™ºè¡Œã‚‚.

ãŸã ã—ãƒã‚¤ãƒ³ãƒˆã¯websocketãŒtçµ±åˆã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹.

http-kitã¯2022å¹´ç¾åœ¨ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹çŠ¶æ³ãŒæ€ªã—ãè¦‹ãˆãŸ.


## clj-http {#clj-http}

<https://github.com/dakrone/clj-http>

[Ring]({{< relref "20220118092453.md#clojure-ring-webã‚µãƒ¼ãƒæŠ½è±¡" >}}) ã®å½±éŸ¿ã‚’å—ã‘ã¦ã„ã‚‹ãŸã‚ Request Mapã‚’å…¥åŠ›ã¨ã—ã¦Response Mapã‚’è¿”ã™.


### tips: debug å‡ºåŠ› {#tips-debug-å‡ºåŠ›}

{:debug true} ã‚’Request Mapã«å«ã‚ã‚‹ã¨, æ¨™æº–å‡ºåŠ›ã«Request Mapã®å†…å®¹ãŒè¡¨ç¤ºã•ã‚Œã‚‹.


### tips: clj-httpã«ãŠã‘ã‚‹jsonã®æ‰±ã„ {#tips-clj-httpã«ãŠã‘ã‚‹jsonã®æ‰±ã„}

Clojureã§JSONã‚’æ‰±ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã‚ã‚‹ [darkrone/cheshire](https://github.com/dakrone/cheshire) ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã¨, jsonã¨ã®é€£æºãŒ{:as :json} ã§ã§ãã‚‹. ã“ã®æŒ‡å®šãŒã•ã‚Œã‚‹ã¨ clj-httpã¯repsonse dataã‚’cheshire ã§jsonã«ãƒ‘ãƒ¼ã‚¹ã™ã‚‹.

ãªãŠ å˜ç´”ã« {:headers {:accept "application/json"}}ã‚’è¨­å®šã—ãŸã„ã ã‘ãªã‚‰{:accept :json}ã‚’æŒ‡å®šã™ã‚‹.

ref: [ğŸ’¡Accept ã¨ Content-Typeã®é•ã„]({{< relref "20220324072101.md#application-jsonã«ãŠã‘ã‚‹accept-ã¨-content-typeã®é•ã„" >}})


### howto: HTTPã‚¨ãƒ©ãƒ¼ã®æ‰±ã„ã¨ä¾‹å¤–ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° {#howto-httpã‚¨ãƒ©ãƒ¼ã®æ‰±ã„ã¨ä¾‹å¤–ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°}

HTTP ResponseãŒæ­£å¸¸çµ‚äº†ä»¥å¤–ã®å ´åˆã¯[slingshot]({{< relref "20220331055419.md#slingshot-enhanced-throw-and-catch-for-clojure" >}})ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è¿”ã™ãŸã‚, slingshotã«åˆã‚ã›ãŸã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒæœŸå¾…ã•ã‚Œã‚‹.

-   [Exceptions - GitHub - dakrone/clj-http](https://github.com/dakrone/clj-http#exceptions)
    -   clj-http READMEã®èª¬æ˜.
-   [Simple error handling using slingshot and clj-http - Oskar ThorÃ©n](https://blog.oskarth.com/simple-error-handling-using-slingshot-and-clj-http)
    -   ã‚·ãƒ³ãƒ—ãƒ«ãªerror handling wrapperå®Ÿè£…ä¾‹.
-   [Handling Exceptions with Middleware in Clojure | 8th Light](https://8thlight.com/blog/mike-knepper/2015/05/19/handling-exceptions-with-middleware-in-clojure.html)
    -   wrap-exceptionã¨ã„ã†ã‚«ã‚¹ã‚¿ãƒ wrapperã¨ [ring-json]({{< relref "20220118092453.md#ring-json-middleware" >}}) ã®çµ„ã¿åˆã‚ã›.


### howto: clj-httpã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’proxyçµŒç”±ã«ã™ã‚‹ã«ã¯ï¼Ÿ {#howto-clj-httpã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’proxyçµŒç”±ã«ã™ã‚‹ã«ã¯}

Request Mapã« proxy-host, prox-port, proxy-user, proxy-passã‚’å«ã‚ã‚‹.

ref: [clj-http: Proxies](https://github.com/dakrone/clj-http#proxies)


### howto: clj-httpã§ WARN log: Invalid 'expires' attribute {#howto-clj-httpã§-warn-log-invalid-expires-attribute}

request mapã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã« **:cookie-policy :standard** ã‚’è¿½åŠ .

ref: [Invalid 'expires' attribute? - GitHub](https://github.com/dakrone/clj-http/issues/325)


### howto: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå€¤ã‚’è¨­å®šã™ã‚‹ã«ã¯ï¼Ÿ {#howto-ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå€¤ã‚’è¨­å®šã™ã‚‹ã«ã¯}

Request Mapã« å€¤ã‚’millsecondã§è¨­å®š.

```clojure
{:socket-timeout 1000
:connection-timeout 1000
:connection-request-timeout 1000}
```

clj-httpã¯ Javaã®Apache HttpClentã®Wrapperã§ã‚ã‚Šä»•æ§˜ã¯ã“ã‚Œã«å¾“ã†. è¨­å®šå¯èƒ½ãªï¼“ã¤ã®å±æ€§ã®æ„å‘³ã¯ãã‚Œãã‚Œä»¥ä¸‹ã®é€šã‚Š.

-   socket timeout: ã‚½ã‚±ãƒƒãƒˆé€šä¿¡ã®ã‚¹ã‚¿ãƒ¼ãƒˆã‹ã‚‰çµ‚äº†ã¾ã§.
-   connection timeout: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã‚µãƒ¼ãƒã¸ã®æ¥ç¶šç¢ºç«‹(3way-shake)ã¾ã§
-   connection-request-timeout: æ¥ç¶šç¢ºç«‹å¾Œã‹ã‚‰ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã‚‹ã¾ã§.

ref. [Javaã®HttpClientã«ãŠã‘ã‚‹3ã¤ã®Timeoutã®é•ã„ã«é–¢ã—ã¦ - Qiita](https://qiita.com/Kohei-Sato-1221/items/5567b24c9d9218424c08)


### ãƒšãƒ¼ã‚¸ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã«ã¯? {#ãƒšãƒ¼ã‚¸ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã«ã¯}

ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ç”¨é€”ã§åˆ©ç”¨ã™ã‚‹ã¨ãã«404ãŒã‹ã‹ã‚‹ã¨ã‚ã‹ã£ã¦ã„ã‚‹ãªã‚‰ã°getã‚’æŠ•ã’ãªã„ã»ã†ãŒã„ã„. ã“ã‚“ãªã¨ãã¯head requestã§äº‹å‰ã«å­˜åœ¨ç¢ºèªã—ãŸã„.

ãŸã ã—clj-httpã§ã¯ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã¯è‡ªå‹•ã§ä¾‹å¤–ã‚’ä¸Šã’ã‚‹ãŸã‚, ãã‚Œã‚’é˜²æ­¢ã—ã¦è‡ªåˆ†ã§ä¸­èº«ã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã¨ãã¯Request Mapã« {:throw-exceptions false} ã‚’è¨­å®šã™ã‚‹.

```clojure
(defn page-exists? [url]
  (if-let [resp (client/head url {:headers          headers
                                  :throw-exceptions false})]
    (= (:status resp) 200)
    false))
```


## References {#references}

å‹‰å¼·ã®å‚è€ƒã«ç›®ã‚’é€šã—ãŸã‚‚ã®ã®ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯.

-   [Clojureã§Qiita APIã‚’ãŸãŸã - Qiita](https://qiita.com/akthrms/items/42af315089229800aefa)
    -   <https://github.com/akthrms/qiita-client-sample>
    -   Qiitaã‚’å©ãã ã‘ã ã‘ã©ä½™è¨ˆãªã‚‚ã®ãŒãªã„ã®ã§ã‚ˆã„.
-   [Clojure tutorial - boot, basic functions and how to do REST requests](https://joaoptrindade.com/clojure-tutorial-part-1-http-requests)
    -   ã¨ãã«Clojureã®REST requestsã«ç€ç›®ã—ãŸãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«Webè¨˜äº‹.
    -   example of clj-http
    -   <https://github.com/joninvski/clojure-tutorial>
