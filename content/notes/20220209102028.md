+++
title = "ğŸ“Clojure API Client Development"
tags = ["WIKI", "Clojure", "API"]
draft = false
+++

-   up: [ğŸ“Clojure Web Development]({{< relref "20220118092453.md" >}})
-   refs:
    -   [ğŸ“Clojure with Twitter Development]({{< relref "20220307193727.md" >}})

ä¸»ã«ã‚µãƒ¼ãƒ“ã‚¹ã®APIã‚’å©ãã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ãƒã‚¦ãƒã‚¦ã¾ã¨ã‚.


## Clojure HTTP Client {#2c684c}

ä¸»ãªã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«http-kitã¨clj-httpãŒã‚ã‚‹.

-   <https://github.com/http-kit/http-kit>
-   <https://github.com/dakrone/clj-http>

httpãƒªã‚¯ã‚¨ã‚¹ãƒˆã«é–¢ã—ã¦ã¯ã©ã¡ã‚‰ã‚‚åŒã˜ã“ã¨ãŒã§ãã‚‹. éåŒæœŸç™ºè¡Œã‚‚.

ãŸã ã—ãƒã‚¤ãƒ³ãƒˆã¯websocketãŒçµ±åˆã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹.

http-kitã¯2022å¹´ç¾åœ¨ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹çŠ¶æ³ãŒæ€ªã—ãè¦‹ãˆãŸ.


## clj-http {#13a79f1f-0d95-4f2a-8c4c-b77c4ed69be1}

<https://github.com/dakrone/clj-http>

[Ring]({{< relref "20220118092453.md#564c8e99-d6d7-49cf-acf8-6382d36443cb" >}}) ã®å½±éŸ¿ã‚’å—ã‘ã¦ã„ã‚‹ãŸã‚ Request Mapã‚’å…¥åŠ›ã¨ã—ã¦Response Mapã‚’è¿”ã™.


### tips: debug å‡ºåŠ› {#f8e61e}

{:debug true} ã‚’Request Mapã«å«ã‚ã‚‹ã¨, æ¨™æº–å‡ºåŠ›ã«Request Mapã®å†…å®¹ãŒè¡¨ç¤ºã•ã‚Œã‚‹.


### tips: clj-httpã«ãŠã‘ã‚‹jsonã®æ‰±ã„ {#b919f5}

Clojureã§JSONã‚’æ‰±ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã‚ã‚‹ [darkrone/cheshire](https://github.com/dakrone/cheshire) ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã¨, jsonã¨ã®é€£æºãŒ{:as :json} ã§ã§ãã‚‹. ã“ã®æŒ‡å®šãŒã•ã‚Œã‚‹ã¨ clj-httpã¯repsonse dataã‚’cheshire ã§jsonã«ãƒ‘ãƒ¼ã‚¹ã™ã‚‹.

ãªãŠ å˜ç´”ã« {:headers {:accept "application/json"}}ã‚’è¨­å®šã—ãŸã„ã ã‘ãªã‚‰{:accept :json}ã‚’æŒ‡å®šã™ã‚‹.

ref: [ğŸ’¡Accept ã¨ Content-Typeã®é•ã„]({{< relref "20220324072101.md#66adf489-f4af-4c2c-8357-4644e205372f" >}})


### howto: HTTPã‚¨ãƒ©ãƒ¼ã®æ‰±ã„ã¨ä¾‹å¤–ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° {#5ec1072e-8666-402b-a867-b6fd3d227eee}

HTTP ResponseãŒæ­£å¸¸çµ‚äº†ä»¥å¤–ã®å ´åˆã¯[slingshot]({{< relref "20220331055419.md#2e6ef68b-b405-489c-8194-17a5e54f3b6d" >}})ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è¿”ã™ãŸã‚, slingshotã«åˆã‚ã›ãŸã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒæœŸå¾…ã•ã‚Œã‚‹.

-   [Exceptions - GitHub - dakrone/clj-http](https://github.com/dakrone/clj-http#exceptions)
    -   clj-http READMEã®èª¬æ˜.
-   [Simple error handling using slingshot and clj-http - Oskar ThorÃ©n](https://blog.oskarth.com/simple-error-handling-using-slingshot-and-clj-http)
    -   ã‚·ãƒ³ãƒ—ãƒ«ãªerror handling wrapperå®Ÿè£…ä¾‹.
-   [Handling Exceptions with Middleware in Clojure | 8th Light](https://8thlight.com/blog/mike-knepper/2015/05/19/handling-exceptions-with-middleware-in-clojure.html)
    -   wrap-exceptionã¨ã„ã†ã‚«ã‚¹ã‚¿ãƒ wrapperã¨ [ring-json]({{< relref "20220118092453.md#b55a2c8e-8f19-4719-9014-8bf43fedb0a8" >}}) ã®çµ„ã¿åˆã‚ã›.


### howto: clj-httpã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’proxyçµŒç”±ã«ã™ã‚‹ã«ã¯ï¼Ÿ {#e7d185}

Request Mapã« proxy-host, prox-port, proxy-user, proxy-passã‚’å«ã‚ã‚‹.

ref: [clj-http: Proxies](https://github.com/dakrone/clj-http#proxies)


### howto: clj-httpã§ WARN log: Invalid 'expires' attribute {#2facd0}

request mapã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã« **:cookie-policy :standard** ã‚’è¿½åŠ .

ref: [Invalid 'expires' attribute? - GitHub](https://github.com/dakrone/clj-http/issues/325)


### howto: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå€¤ã‚’è¨­å®šã™ã‚‹ã«ã¯ï¼Ÿ {#dc2d53}

Request Mapã« å€¤ã‚’millsecondã§è¨­å®š.

```clojure
{:socket-timeout 1000
:connection-timeout 1000
:connection-request-timeout 1000}
```

clj-httpã¯ Javaã®Apache HttpClentã®Wrapperã§ã‚ã‚Šä»•æ§˜ã¯ã“ã‚Œã«å¾“ã†. è¨­å®šå¯èƒ½ãªï¼“ã¤ã®å±æ€§ã®æ„å‘³ã¯ãã‚Œãã‚Œä»¥ä¸‹ã®é€šã‚Š.

-   socket timeout: ã‚½ã‚±ãƒƒãƒˆé€šä¿¡ã®ã‚¹ã‚¿ãƒ¼ãƒˆã‹ã‚‰çµ‚äº†ã¾ã§.
-   connection timeout: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã‚µãƒ¼ãƒã¸ã®æ¥ç¶šç¢ºç«‹(3way-shake)ã¾ã§
-   connection-request-timeout: æ¥ç¶šç¢ºç«‹å¾Œã‹ã‚‰ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã‚‹ã¾ã§.

ref. [Javaã®HttpClientã«ãŠã‘ã‚‹3ã¤ã®Timeoutã®é•ã„ã«é–¢ã—ã¦ - Qiita](https://qiita.com/Kohei-Sato-1221/items/5567b24c9d9218424c08)


### ãƒšãƒ¼ã‚¸ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã«ã¯? {#921c89}

ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ç”¨é€”ã§åˆ©ç”¨ã™ã‚‹ã¨ãã«404ãŒã‹ã‹ã‚‹ã¨ã‚ã‹ã£ã¦ã„ã‚‹ãªã‚‰ã°getã‚’æŠ•ã’ãªã„ã»ã†ãŒã„ã„. ã“ã‚“ãªã¨ãã¯head requestã§äº‹å‰ã«å­˜åœ¨ç¢ºèªã—ãŸã„.

ãŸã ã—clj-httpã§ã¯ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã¯è‡ªå‹•ã§ä¾‹å¤–ã‚’ä¸Šã’ã‚‹ãŸã‚, ãã‚Œã‚’é˜²æ­¢ã—ã¦è‡ªåˆ†ã§ä¸­èº«ã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã¨ãã¯Request Mapã« {:throw-exceptions false} ã‚’è¨­å®šã™ã‚‹.

```clojure
(defn page-exists? [url]
  (if-let [resp (client/head url {:headers          headers
                                  :throw-exceptions false})]
    (= (:status resp) 200)
    false))
```


## Clojure API Clienté–‹ç™ºã®ãƒˆãƒ”ãƒƒã‚¯ {#52871d}


### Clojureã§ã‚¯ã‚¨ãƒªæ–‡å­—åˆ—ã‚’ç”Ÿæˆã™ã‚‹ã«ã¯? {#73a87b}

[ã‚¯ã‚¨ãƒªæ–‡å­—åˆ—]({{< relref "20220324072101.md#28c64a45-7f21-461e-b53a-18d5875ae734" >}})ã‚’Clojureã§ç”Ÿæˆã™ã‚‹æ–¹æ³•

-   ring.util.codec/url-encode ã‚’ä½¿ã†.
-   clj-http.client/generate-query-stringã‚’ä½¿ã†.
-   java.net.URLEncoder/encodeã‚’ä½¿ã†.

---

ref. [Clojure building of URL from constituent parts - Stack Overflow](https://stackoverflow.com/questions/3644125/clojure-building-of-url-from-constituent-parts)


## References {#d95867}

å‹‰å¼·ã®å‚è€ƒã«ç›®ã‚’é€šã—ãŸã‚‚ã®ã®ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯.

-   [Clojureã§Qiita APIã‚’ãŸãŸã - Qiita](https://qiita.com/akthrms/items/42af315089229800aefa)
    -   <https://github.com/akthrms/qiita-client-sample>
    -   Qiitaã‚’å©ãã ã‘ã ã‘ã©ä½™è¨ˆãªã‚‚ã®ãŒãªã„ã®ã§ã‚ˆã„.
-   [Clojure tutorial - boot, basic functions and how to do REST requests](https://joaoptrindade.com/clojure-tutorial-part-1-http-requests)
    -   ã¨ãã«Clojureã®REST requestsã«ç€ç›®ã—ãŸãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«Webè¨˜äº‹.
    -   example of clj-http
    -   <https://github.com/joninvski/clojure-tutorial>
