+++
title = "ğŸ“Clojure API Client Development"
tags = ["WIKI", "Clojure", "API"]
draft = false
+++

-   up: [ğŸ“Clojure Web Development]({{< relref "20220118092453.md" >}})
-   refs:
    -   [ğŸ“Clojure with Twitter Development]({{< relref "20220307193727.md" >}})

ä¸»ã«ã‚µãƒ¼ãƒ“ã‚¹ã®APIã‚’å©ãã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ãƒã‚¦ãƒã‚¦ã¾ã¨ã‚.


## Clojure HTTP Client {#clojure-http-client}

tags: [ğŸ”–HTTP]({{< relref "20220324072101.md" >}})

ä¸»ãªã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«http-kitã¨clj-httpãŒã‚ã‚‹.

-   <https://github.com/http-kit/http-kit>
-   <https://github.com/dakrone/clj-http>

httpãƒªã‚¯ã‚¨ã‚¹ãƒˆã«é–¢ã—ã¦ã¯ã©ã¡ã‚‰ã‚‚åŒã˜ã“ã¨ãŒã§ãã‚‹. éåŒæœŸç™ºè¡Œã‚‚.

ãŸã ã—ãƒã‚¤ãƒ³ãƒˆã¯websocketãŒçµ±åˆã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹.

http-kitã¯2022å¹´ç¾åœ¨ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹çŠ¶æ³ãŒæ€ªã—ãè¦‹ãˆãŸ.


## clj-http {#clj-http}

<https://github.com/dakrone/clj-http>

[Ring]({{< relref "20220118092453.md#clojure-ring" >}}) ã®å½±éŸ¿ã‚’å—ã‘ã¦ã„ã‚‹ãŸã‚ Request Mapã‚’å…¥åŠ›ã¨ã—ã¦Response Mapã‚’è¿”ã™.

ä»¥ä¸‹å°æŠ€. ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã«ã¯clj-httpã¨ã„ã†ã‚ˆã‚Šã‚‚HTTPãƒ—ãƒ­ãƒˆã‚³ãƒ«ã®ä¸€èˆ¬çš„ãªç†è§£ã‚„çµŒé¨“ãŒç”Ÿãã¦ãã‚‹.


### tips: debug å‡ºåŠ› {#tips-debug-å‡ºåŠ›}

{:debug true} ã‚’Request Mapã«å«ã‚ã‚‹ã¨, æ¨™æº–å‡ºåŠ›ã«Request Mapã®å†…å®¹ãŒè¡¨ç¤ºã•ã‚Œã‚‹.


### tips: clj-httpã«ãŠã‘ã‚‹jsonã®æ‰±ã„ {#tips-clj-httpã«ãŠã‘ã‚‹jsonã®æ‰±ã„}

Clojureã§JSONã‚’æ‰±ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã‚ã‚‹ [darkrone/cheshire](https://github.com/dakrone/cheshire) ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã¨, jsonã¨ã®é€£æºãŒ{:as :json} ã§ã§ãã‚‹. ã“ã®æŒ‡å®šãŒã•ã‚Œã‚‹ã¨ clj-httpã¯repsonse dataã‚’cheshire ã§jsonã«ãƒ‘ãƒ¼ã‚¹ã™ã‚‹.

ãªãŠ å˜ç´”ã« {:headers {:accept "application/json"}}ã‚’è¨­å®šã—ãŸã„ã ã‘ãªã‚‰{:accept :json}ã‚’æŒ‡å®šã™ã‚‹.

ref: [ğŸ’¡Accept ã¨ Content-Typeã®é•ã„]({{< relref "20220324072101.md#application-jsonã«ãŠã‘ã‚‹accept-ã¨-content-typeã®é•ã„" >}})


### howto: HTTPã‚¨ãƒ©ãƒ¼ã®æ‰±ã„ã¨ä¾‹å¤–ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° {#howto-httpã‚¨ãƒ©ãƒ¼ã®æ‰±ã„ã¨ä¾‹å¤–ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°}

clj-httpã¯HTTP ResponseãŒæ­£å¸¸çµ‚äº†ä»¥å¤–ã®å ´åˆ(200 201 202 203 204 205 206 207 300 301 302 303 304 307)ã¯[slingshot]({{< relref "20220331055419.md#slingshot-enhanced-throw-and-catch-for-clojure" >}})ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è¿”ã™ãŸã‚, slingshotã«åˆã‚ã›ãŸã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒæœŸå¾…ã•ã‚Œã‚‹.

ã™ãªã‚ã¡(try... (catch Exception ex))ã§è£œè¶³ã™ã‚‹ã‹, slingshotã®try+ blockã‚’ä½¿ã†ã‹. slingshotã¯clj-httpã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã¨ä¸€ç·’ã«ã¤ã„ã¦ãã‚‹.

-   [Exceptions - GitHub - dakrone/clj-http](https://github.com/dakrone/clj-http#exceptions)
    -   clj-http READMEã®èª¬æ˜.
-   [Simple error handling using slingshot and clj-http - Oskar ThorÃ©n](https://blog.oskarth.com/simple-error-handling-using-slingshot-and-clj-http)
    -   ã‚·ãƒ³ãƒ—ãƒ«ãªerror handling wrapperå®Ÿè£…ä¾‹.


### howto: clj-httpã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’proxyçµŒç”±ã«ã™ã‚‹ã«ã¯ï¼Ÿ {#howto-clj-httpã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’proxyçµŒç”±ã«ã™ã‚‹ã«ã¯}

Request Mapã« proxy-host, prox-port, proxy-user, proxy-passã‚’å«ã‚ã‚‹.

ref: [clj-http: Proxies](https://github.com/dakrone/clj-http#proxies)


### howto: clj-httpã§ WARN log: Invalid 'expires' attribute {#howto-clj-httpã§-warn-log-invalid-expires-attribute}

request mapã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã« **:cookie-policy :standard** ã‚’è¿½åŠ .

ref: [Invalid 'expires' attribute? - GitHub](https://github.com/dakrone/clj-http/issues/325)


### howto: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå€¤ã‚’è¨­å®šã™ã‚‹ã«ã¯ï¼Ÿ {#howto-ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå€¤ã‚’è¨­å®šã™ã‚‹ã«ã¯}

Request Mapã« å€¤ã‚’millsecondã§è¨­å®š.

```clojure
{:socket-timeout 1000
 :connection-timeout 1000
 :connection-request-timeout 1000}
```

clj-httpã¯ Javaã®Apache HttpClentã®Wrapperã§ã‚ã‚Šä»•æ§˜ã¯ã“ã‚Œã«å¾“ã†.

[SocketTimeout/Connection Timeout/Connection Request Timeout]({{< relref "20220802090757.md#sockettimeout-connection-timeout-connection-request-timeout" >}})


### :throw-exceptions falseã«ã‚ˆã‚‹ä¾‹å¤–æŠ‘æ­¢ {#throw-exceptions-falseã«ã‚ˆã‚‹ä¾‹å¤–æŠ‘æ­¢}

Effective Java "Use Excetions only for exceptional conditions"ã«å¾“ã†ã¨, {:thrwo-exceptions false}ã«ã™ã‚‹ã“ã¨ã§ä¾‹å¤–æŠ‘æ­¢ã—ã¤ã¤è‡ªåˆ†ã§ä¾‹å¤–å‡¦ç†ã‚’ã‹ãã®ãŒå‰.


### ãƒšãƒ¼ã‚¸ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã«ã¯? {#ãƒšãƒ¼ã‚¸ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã«ã¯}

ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ç”¨é€”ã§åˆ©ç”¨ã™ã‚‹ã¨ãã«404ãŒã‹ã‹ã‚‹ã¨ã‚ã‹ã£ã¦ã„ã‚‹ãªã‚‰ã°getã‚’æŠ•ã’ãªã„ã»ã†ãŒã„ã„. ã“ã‚“ãªã¨ãã¯head requestã§äº‹å‰ã«å­˜åœ¨ç¢ºèªã—ãŸã„.

ãŸã ã—clj-httpã§ã¯ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã¯è‡ªå‹•ã§ä¾‹å¤–ã‚’ä¸Šã’ã‚‹ãŸã‚, ãã‚Œã‚’é˜²æ­¢ã—ã¦è‡ªåˆ†ã§ä¸­èº«ã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã¨ãã¯Request Mapã« {:throw-exceptions false} ã‚’è¨­å®šã™ã‚‹.

```clojure
(defn page-exists? [url]
  (if-let [resp (client/head url {:headers          headers
                                  :throw-exceptions false})]
    (= (:status resp) 200)
    false))
```


### <span class="org-todo todo _">ğŸ”—</span> References {#references}

-   [Production Considerations for clj-http Â· rymndhng](https://rymndhng.github.io/2020/04/15/production-considerations-for-clj-http/)
    -   å®Ÿè·µhttp requestçš„ãª. ã‚¬ãƒã‚‹ãªã‚‰å¿…èª­.


## Clojure API Clienté–‹ç™ºã®ãƒˆãƒ”ãƒƒã‚¯ {#clojure-api-clienté–‹ç™ºã®ãƒˆãƒ”ãƒƒã‚¯}


### Clojureã§ã‚¯ã‚¨ãƒªæ–‡å­—åˆ—ã‚’ç”Ÿæˆã™ã‚‹ã«ã¯? {#clojureã§ã‚¯ã‚¨ãƒªæ–‡å­—åˆ—ã‚’ç”Ÿæˆã™ã‚‹ã«ã¯}

[ã‚¯ã‚¨ãƒªæ–‡å­—åˆ—]({{< relref "20220324072101.md#ã‚¯ã‚¨ãƒªæ–‡å­—åˆ—" >}})ã‚’Clojureã§ç”Ÿæˆã™ã‚‹æ–¹æ³•

-   ring.util.codec/url-encode ã‚’ä½¿ã†.
-   clj-http.client/generate-query-stringã‚’ä½¿ã†.
-   java.net.URLEncoder/encodeã‚’ä½¿ã†.

---

ref. [Clojure building of URL from constituent parts - Stack Overflow](https://stackoverflow.com/questions/3644125/clojure-building-of-url-from-constituent-parts)


### <span class="org-todo todo _">âš™</span> let or throw pattern on http request {#let-or-throw-pattern-on-http-request}

ref. [ğŸ”if-let ã¯å‡¦ç†ã®çµæœã«ã‚ˆã‚‹åˆ†å²ã§ã¤ã‹ã†]({{< relref "20220116083656.md#if-let-ã¯å‡¦ç†ã®çµæœã«ã‚ˆã‚‹åˆ†å²ã§ã¤ã‹ã†" >}})

```clojure
(let [resp (client/get xxx)]
  (-> resp
      :body
      xxx
      (or (throw (ex-info "Exception occured"
                          {:response resp})))))
```


### <span class="org-todo todo _">âš™</span> pcoll pattern in clojure http request {#pcoll-pattern-in-clojure-http-request}

http requestã®å‘¼ã³å‡ºã—ã§ã‚ˆãä½¿ã†ã¨æ€ã†. applyãŒãƒŸã‚½.

[pcoll pattern on Clojure]({{< relref "20220331055419.md#pcoll-pattern-on-clojure" >}})

```clojure
(defn request [req-fn & req-args]
  (try
    (when-let [resp (apply req-fn req-args)]
      resp)
    (catch Exception e [false e])))
```


## Clojure WebSocket Client {#clojure-websocket-client}

tags: [ğŸ”–websocket]({{< relref "20220801202422.md" >}})

å½“ç„¶æµè¡Œã‚Šã™ãŸã‚ŠãŒã‚ã‚‹ã‚‚ã®ã®2022ç¾åœ¨ã®ä¸»ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯senteã¨http-kitã®2å¼·ã‹ãª?

-   <https://github.com/ptaoussanis/sente>
-   <https://github.com/http-kit/http-kit>


## sente {#sente}

senteã¯æ—¥æœ¬èªã®å›²ç¢ã®å…ˆæ‰‹ãŒç”±æ¥ã¨ã‹wwwå…ˆæ‰‹ã‚’æ‰“ã¤ãã‚‰ã„çˆ†é€Ÿã‚’ç›®æŒ‡ã™è¨­è¨ˆæ€æƒ³, å…ˆæ‰‹å¿…å‹!!!

[timbre]({{< relref "20220211142329.md#timbre" >}})ã¨åŒã˜ä½œè€…. ã“ã®äººtempuraã¿ãŸãªåå‰ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ã‹ã‚‚ã¤ãã£ã¦ã‚‹ã®ã§æ—¥æœ¬å¥½ãã ãªw


### <span class="org-todo todo _">ğŸ”—</span> References {#references}

-   senteã¨integranté€£æºã¯ [Clojure: Roll]({{< relref "20220211142329.md#clojure-roll" >}})ã®ã‚³ãƒ¼ãƒ‰ãŒå‚è€ƒã«ãªã‚‹([GitHub](https://github.com/dimovich/roll/blob/master/src/clj/roll/sente.clj)).
-   [Clojureã§Webã‚¢ãƒ—ãƒªç¶šã(WebSocketã¨ãƒãƒ£ãƒƒãƒˆ) - ãã¬ã“BLOG](https://zonuko.github.io/posts/2018/05/15/clojure-web2/#.YufhBHVBxhE)


## References {#references}

å‹‰å¼·ã®å‚è€ƒã«ç›®ã‚’é€šã—ãŸã‚‚ã®ã®ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯.

-   [Clojureã§Qiita APIã‚’ãŸãŸã - Qiita](https://qiita.com/akthrms/items/42af315089229800aefa)
    -   <https://github.com/akthrms/qiita-client-sample>
    -   Qiitaã‚’å©ãã ã‘ã ã‘ã©ä½™è¨ˆãªã‚‚ã®ãŒãªã„ã®ã§ã‚ˆã„.
-   [Clojure tutorial - boot, basic functions and how to do REST requests](https://joaoptrindade.com/clojure-tutorial-part-1-http-requests)
    -   ã¨ãã«Clojureã®REST requestsã«ç€ç›®ã—ãŸãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«Webè¨˜äº‹.
    -   example of clj-http
    -   <https://github.com/joninvski/clojure-tutorial>
