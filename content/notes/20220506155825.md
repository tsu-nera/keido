+++
title = "ğŸ“Clojure ãƒãƒ«ãƒãƒ¡ã‚½ãƒƒãƒ‰ | Multimethod"
tags = ["WIKI"]
draft = false
+++

-   up: [ğŸ“Clojure Expression Problem]({{< relref "20220307162746.md" >}})
-   refs.
    -   [ğŸ“Clojureãƒ—ãƒ­ãƒˆã‚³ãƒ«(Protocols)]({{< relref "20220517114759.md" >}})
    -   [ğŸ”—defmulti - clojure.core | ClojureDocs](https://clojuredocs.org/clojure.core/defmulti)
    -   [ğŸ”—ãƒãƒ«ãƒãƒ¡ã‚½ãƒƒãƒ‰(multimethod)ã¨éšå±¤ - clojure.org(ja)](https://japan-clojurians.github.io/clojure-site-ja/reference/multimethods)


## ãƒãƒ«ãƒãƒ¡ã‚½ãƒƒãƒ‰(multimethod)ã¨ã¯ {#ãƒãƒ«ãƒãƒ¡ã‚½ãƒƒãƒ‰--multimethod--ã¨ã¯}

ã²ã¨è¨€ã§è¨€ã„æ›ãˆã‚Œã°, æ¡ä»¶åˆ†å²ãŒã—ãŸããªã£ãŸã‚‰ç¾ã—ãã‚­ãƒ¡ã‚‹æŠ€.

æ“ä½œã®æ¡ä»¶åˆ†å²ã®è¤‡é›‘ã•ã®èª²é¡Œ([Expression Problem]({{< relref "20220307102236.md" >}}))ã‚’è§£æ±ºã™ã‚‹ã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹.

---

Javaã® ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã‚’Clojureã§å®Ÿç¾ã™ã‚‹æ–¹æ³•.

åŒä¸€åç§°ã®ãƒ¡ã‚½ãƒƒãƒ‰ã§ç•°ãªã‚‹å‹ã«ã‚ˆã£ã¦å‡¦ç†ã‚’åˆ†ã‘ã‚‹ã‚ˆã†ãªã“ã¨ã‚’ã—ã‚ˆã†ã¨ã™ã‚‹ã¨Clojureã§ã¯,

-   **defmulti** ã§è¤‡æ•°ã®å‡¦ç†ã‚’åˆ†å²ã•ã›ã‚‹ãŸã‚ã®åŒä¸€åç§°ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®šç¾©.
-   **defmethod** ã§ç•°ãªã‚‹å‡¦ç†ã‚’å‹ã”ã¨ã«è¨˜è¿°.

defmultiã§ä¸ãˆã‚‰ã‚ŒãŸå¼•æ•°ã®ã©ã‚Œã‚’dispatchã®ãŸã‚ã®åˆ†å²æ¡ä»¶ã«ã™ã‚‹ã‹ã‚’å®šç¾©ã™ã‚‹. ã„ã„ã‹ãˆã‚Œã°, å¼•æ•°ã‚’ã°ã‚‰ã—ã¦åˆ†å²æ¡ä»¶ã‚’æ±ºã‚ã‚‹. defmethodã§åˆ†å²æ¡ä»¶ã«åŸºã¥ã„ã¦ä¸ãˆã‚‰ã‚ŒãŸå¼•æ•°ã‚’å‡¦ç†ã™ã‚‹.

Javaã ã¨Classã«ã‚ˆã£ã¦ç•°ãªã‚‹å®Ÿè£…ã‚’å‘¼ã³å‡ºã™, Clojureã ã¨å¼•æ•°ã™ã¹ã¦ã«ãŠã„ã¦ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒå¯èƒ½ã¨ã„ã†ç‚¹ã«ãŠã„ã¦Javaã‚ˆã‚Šå¼·åŠ›ãªæ–‡æ³•ã«ãªã£ã¦ã„ã‚‹.


### quick example {#quick-example}

å¼•æ•° sã«å¯¾ã™ã‚‹ãƒãƒ©ã—æ–¹ã‚’å®šç¾©.

```clojure
(defmulti my-print class)
```

class ã¯ (fn [x] (class x)) ã¨ã„ã†ç„¡åé–¢æ•°ã®ç³–è¡£æ§‹æ–‡ã«ã™ããªã„.

å¼•æ•°sãŒstring, ã¤ã¾ã‚Š (class s) => String ãªã‚‰ã°(.write **out** s)ã‚’å®Ÿè¡Œ.

```clojure
(defmethod my-print String [s] (.write *out* s))
(defmethod my-print nil [s] (.write *out* "nil"))
```

multimethodå‘¼ã³å‡ºã—.

```clojure
(my-print "stu")
```


## æ“ä½œå¯¾è±¡ã®ã‚°ãƒ«ãƒ¼ãƒ—åŒ–(derive/isa?) {#æ“ä½œå¯¾è±¡ã®ã‚°ãƒ«ãƒ¼ãƒ—åŒ–--derive-isa}

protocolãŒæ“ä½œã®ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã«å¯¾ã—ã¦multimethodã¯æ“ä½œå¯¾è±¡ã®ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ãŒã§ãã‚‹. ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒå€¤ã¨ãã‚Œã«å¯¾ã™ã‚‹ **derive/isa?** ã‚’åˆ©ç”¨ã™ã‚‹. deriveã¨ã¯æ´¾ç”Ÿ(derivation)ã®å‹•è©ã®æ„. deriveã§é–¢ä¿‚ã‚’å®šç¾©ã—ã¦isa?ã§é–¢ä¿‚ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹.

Clojureã¯ç¶™æ‰¿ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ãªã„ã®ã§å‹ã®è¦ªå­é–¢ä¿‚ã‚’è¡¨ç¾ã§ããªã„ãŒ, dervieã«ã‚ˆã‚Šãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒã™ã‚‹å¯¾è±¡ã«å¯¾ã™ã‚‹è¦ªå­é–¢ä¿‚ã‚’å®šç¾©ã™ã‚‹ã“ã¨ãŒã§ãã‚‹.

ref. [derive - clojure.core | ClojureDocs](https://clojuredocs.org/clojure.core/derive)


### ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒå€¤ {#ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒå€¤}

åå‰ç©ºé–“ã§ä¿®é£¾ã•ã‚ŒãŸã‚·ãƒ³ãƒœãƒ«ã¨ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§è¡¨ç¾ã•ã‚Œã‚‹ç‰¹æ®Šå½¢å¼. (:åå‰ç©ºé–“)/(keyword)ã®ã‚ˆã†ã«è¡¨ç¾ã•ã‚Œã‚‹ãŒ, å®Ÿéš›ã®ä»•æ§˜ä¾‹ã§ã¯(::keyword)ã¨çœç•¥è¡¨ç¾ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒå¤šã„. ãƒ€ãƒ–ãƒ«ã‚³ãƒ­ãƒ³(::)ã¯ åå‰ç©ºé–“ã‚’æŒ‡ã™ãƒªãƒ¼ãƒ€ãƒã‚¯ãƒ­.

```clojure
::rect
;;-> :user/rect
```

[Integrant]({{< relref "20220211142329.md#clojure-integrant" >}}) ã§ã‚‚ã‚ˆãã¿ã‹ã‘ã‚‹è¡¨è¨˜ã§ã‚ã‚Šã“ã“ã‹ã‚‰ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒå€¤ã®å­˜åœ¨ã‚’çŸ¥ã‚‹äººã‚‚å¤šã„ã¨æ€ã†.


### è¦ªå­é–¢ä¿‚ã®å®šç¾©(derive) {#è¦ªå­é–¢ä¿‚ã®å®šç¾©--derive}

(derive å­ä¾› è¦ª) ã‚’ä½¿ã£ã¦éšå±¤çš„ãªé–¢é€£ã‚’å®šç¾©.

```clojure
(derive ::rect ::shape)
(derive ::square ::rect)
```

ã‚‚ã—ãã¯ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒå€¤ã®ä»£ã‚ã‚Šã«Javaã‚¯ãƒ©ã‚¹ã‚‚å®šç¾©å¯èƒ½.

```clojure
(derive java.util.Map ::collection)
(derive java.util.Collection ::collection)

(isa? java.util.HashMap ::collection)
-> true
```


## ğŸ’¡ã„ã¤ãƒãƒ«ãƒãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã†ã¹ãã‹? {#ã„ã¤ãƒãƒ«ãƒãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã†ã¹ãã‹}

ref.) [ğŸ“šProgramming Clojure]({{< relref "20220307081341.md" >}}) ã‚ˆã‚Šå¼•ç”¨.

ç­†è€…ãŒã©ã‚“ã¨ãªã“ã‚ã§ãƒãƒ«ãƒãƒ¡ã‚½ãƒƒãƒ‰ãŒä½¿ã‚ã‚Œã¦ã„ã‚‹ã‹èª¿æŸ»ã—ãŸã¨ãã®ç™ºè¦‹.

-   ãƒãƒ«ãƒãƒ¡ã‚½ãƒƒãƒ‰ã¯ **ã‚ã£ãŸã«ä½¿ã‚ã‚Œãªã„**.
-   ãƒãƒ«ãƒãƒ¡ã‚½ãƒƒãƒ‰ã¯ã‚¯ãƒ©ã‚¹ã«ã‚ˆã‚ŠDispatchã—ã¦ã„ã‚‹ã“ã¨ãŒå¤šã„.

ç­†è€…ã«ã‚ˆã‚‹ææ¡ˆ.

-   é–¢æ•°ãŒ1ã¤ã¾ãŸã¯è¤‡æ•°ã®å‹ã«ã‚ˆã£ã¦åˆ†å²ã—ã¦ã„ãŸã‚‰, ãƒãƒ«ãƒãƒ¡ã‚½ãƒƒãƒ‰ã‚’æ¤œè¨ã™ã‚‹. å‹ã¨ã¯ã‚¯ãƒ©ã‚¹ã‚„keywordã«é™ã‚‰ãªã„. ã‚ãªãŸãŒåˆ†å²ã™ã‚‹ã‚‚ã®ã¨æ„Ÿã˜ã‚‹ã‚‚ã®.
-   åˆ¤æ–­ã«è¿·ã£ãŸã‚‰é–¢æ•°ç‰ˆã¨ãƒãƒ«ãƒãƒ¡ã‚½ãƒƒãƒ‰ç‰ˆã‚’ä¸¡æ–¹æ›¸ã„ã¦ã¿ã¦èª­ã¿ã‚„ã™ã„æ–¹ã‚’é¸ã¶.

---

ğŸ¤”ã‚‚ã—æ¡ä»¶åˆ†å²ãŒæ•°å€‹ã§åˆ†å²ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ±‚ã‚ã‚‹ãƒ•ã‚©ãƒ¼ãƒ ã‚‚å˜ç´”ãªã‚‰multimethodã¯ã„ã‚‰ãªã„ã‹ã‚‚ã—ã‚Œãªã„. 3ã¤ä»¥ä¸Šãªã©è‡ªåˆ†ã§åŸºæº–ã‚’æŒã£ã¦ãŠãã®ã‚‚ã„ã„ã‹ã‚‚(æ¨æ¸¬ã ã¨ãƒªãƒ•ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã¤ã‹ã†ã®ã‹ãªï¼Ÿãã†ãªã‚‰ã°å¤šç”¨ã™ã‚‹ã®ã¯å•é¡Œãªæ°—ãŒã—ãŸ).


## clojure multimethod HOWTO {#clojure-multimethod-howto}

ç‰¹å®šæ¡ä»¶ã«ã‚ˆã‚‹ifæ–‡, switchæ–‡, caseæ–‡ã®ãŠã°ã‘ã«ãªã‚Šãã†ãªã¨ãã¯ç©æ¥µçš„ã«å°å…¥ã—ãŸã„ã¨ã“ã‚. å‹ã¨ã¯ã‚¯ãƒ©ã‚¹ã‚„keywordã§ã¯ãªãåˆ†å²ã—ãŸã„å…¨ã¦, ã¨ã„ã†ã“ã¨ã§ã„ã‚ã„ã‚ã¾ã¨ã‚ã‚‹.


### ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§å‡¦ç†ã‚’åˆ†å²ã—ãŸã„ {#ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§å‡¦ç†ã‚’åˆ†å²ã—ãŸã„}

ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«å¿œã˜ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ã™ã‚‹ä¾‹.

```clojure
(defmulti ->foo (fn [x y] x))
(defmethod ->foo :type-a [x y] y)
(->foo :type-a {})
```


### ã‚­ãƒ¼ã«bindã•ã‚Œã¦ã„ã‚‹valueã§å‡¦ç†ã‚’åˆ†å²ã—ãŸã„ {#ã‚­ãƒ¼ã«bindã•ã‚Œã¦ã„ã‚‹valueã§å‡¦ç†ã‚’åˆ†å²ã—ãŸã„}

```clojure
(def m {:a "hoge"})

(defmulti ->foo :a)
(defmethod ->foo "hoge" xxx)
```

defmultiã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒä¸ãˆã‚‰ã‚Œã¦ã‚‚å®Ÿéš›ã¯ (fn [x] (get x :a)) ã®ç³–è¡£ã®é–¢æ•°ã§ã‚ã‚‹ã¨ã“ã‚ã¯ãƒãƒã£ãŸ...

è¤‡æ•°ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯ ã§ã„ã‘ã‚‹(ref. [juxt]({{< relref "20220116094551.md#clojure-juxt" >}})).

```clojure
;; Define the multimethod
(defmulti service-charge (juxt :id :tag))

;; Handlers for resulting dispatch values
(defmethod service-charge [::acc/Basic   ::acc/Checking] [_] 25)
(defmethod service-charge [::acc/Basic   ::acc/Savings]  [_] 10)
```


### defmethodã‚’ç•°ãªã‚‹namespace(file)ã§å®šç¾©ã—ãŸã„ {#defmethodã‚’ç•°ãªã‚‹namespace--file--ã§å®šç¾©ã—ãŸã„}

ã„ã‚ã‚†ã‚‹ [Open-Closed Principle]({{< relref "20220516232308.md#open-closed-principle-é–‹æ”¾-é–‰é–åŸå‰‡" >}}) ã‚’Clojureã§ã©ã†ã‚„ã‚‹ã‹ã¨ã„ã†ã¯ãªã—.

---

å˜ä¸€ã® ifã«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§åˆ†å²æ¡ä»¶ã‚’æ¸¡ã—ã¦ãã‚Œãã‚Œã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã—ãŸã„. caseæ–‡ã§æ¡ä»¶åˆ†å²ã‚’ã—ã‚ˆã†ã¨ã™ã‚‹ã¨, ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ã®namespaceã‚’requireã™ã‚‹å¿…è¦ãŒã‚ã‚‹.

ã“ã‚Œã ã‘ãªã‚‰ã„ã„ã®ã ãŒï¼Œãã‚Œãã‚Œã®ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ã‹ã‚‰å…±é€šå‡¦ç†ã‚’ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã¨ã—ã¦å‘¼ã³å‡ºã—ãŸã„ã¨ã, cyclic dependenciesãŒç™ºç”Ÿã—ã¦ã—ã¾ã†.

ã“ã®å ´åˆinterfaceç”¨ã®namespaceã‚’ä½œæˆã—ã¦ãã“ã«defmultiã‚’å®šç¾©ã™ã‚‹. è©³ã—ã¯ä»¥ä¸‹ã®stackoverflowå‚ç…§

ref. [protocols - Using Clojure multimethods defined across multiple namespaces - Stack Overflow](https://stackoverflow.com/questions/39585510/using-clojure-multimethods-defined-across-multiple-namespaces)

---

ãŸã ã“ã®å ´åˆã¯multimethodã§ã¯ãªãprotocolã‚’åˆ©ç”¨ã™ã‚‹ã¹ãã‹ã‚‚ã—ã‚Œãªã„. namespaceã¨ã„ã†ã®ãŒè¤‡æ•°ã®ãƒ‡ãƒ¼ã‚¿ã¨æ“ä½œã‚’ã²ã¨ã¤ã®ç’°å¢ƒã«bindã™ã‚‹ã®ãªã‚‰ã°è¤‡æ•°ã®æ“ä½œãŒå‰æã¨ãªã‚Š, ãã‚Œã¯æ“ä½œã®ã‚°ãƒ«ãƒ¼ãƒ”ãƒ³ã‚°ã‚’æ‹…ã† protocolã®å½¹ç›®.

see also. [ğŸ’¡Clojure multimehod vs protocols æ¯”è¼ƒ]({{< relref "20220307162746.md#clojure-multimehod-vs-protocols-æ¯”è¼ƒ" >}})


## ğŸ”—References {#references}

-   ãƒãƒ«ãƒãƒ¡ã‚½ãƒƒãƒ‰ã¯ [Integrant]({{< relref "20220211142329.md#clojure-integrant" >}}) ã§å¤šç”¨ã•ã‚Œã¦ã„ã‚‹.
-   [ğŸ’¡preferring to build a large library of functions on a small set of types]({{< relref "20220116161735.md#preferring-to-build-a-large-library-of-functions-on-a-small-set-of-types" >}})
