+++
title = "ğŸ“Clojure: ãƒ—ãƒ­ãƒˆã‚³ãƒ«(Protocols)"
tags = ["WIKI"]
draft = false
+++

Clojureãƒ—ãƒ­ãƒˆã‚³ãƒ«. Javaã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹ã®ä»£æ›¿.

up: [ğŸ“Clojure Expression Problem]({{< relref "20220307162746.md" >}})


## ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã®å®šç¾© | defprotocol {#ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã®å®šç¾©-defprotocol}

**defprotocol** ã§ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã¨ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®šç¾©ã™ã‚‹.

**extend** (ã¾ãŸã¯ãã®ãƒã‚¯ãƒ­ã§ã‚ã‚‹expand-type/expand-protocol)ã§å®šç¾©ã—ãŸãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚’å‹ã«é©ç”¨ã™ã‚‹. ã¾ãŸã¯deftype/defrecordã«ã‚ˆã£ã¦å‹ã‚’å®šç¾©ã™ã‚‹ã¨ãã«ã¯ã˜ã‚ã‹ã‚‰çµ„ã¿è¾¼ã‚€. å‰è€…ã¯å‹•çš„ã«å‹ã‚’æ‹¡å¼µã—ã¦ã„ã‚‹.

ref. [defprotocol - clojure.core | ClojureDocs](https://clojuredocs.org/clojure.core/defprotocol)


## Type/Recordã¨ã®é€£æº {#type-recordã¨ã®é€£æº}

defprotocolã§å®šç¾©ã—ãŸãƒ—ãƒ­ãƒˆã‚³ãƒ«ã¯ [Clojure Records]({{< relref "20220517092508.md" >}}) ã«çµ„ã¿è¾¼ã‚€ã“ã¨ãŒã§ãã‚‹.

```clojure
(defprotocol Fly
  (fly [this] "Method to fly"))

(defrecord Bird [name species]
  Fly
  (fly [this] (str (:name this) " flies...")))
```

Recordã«ã¯è¤‡æ•°ã®Protocolã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ãŒå¯èƒ½(cf. mix-in, å¤šé‡ç¶™æ‰¿).

---

ã™ã§ã«å®šç¾©ã—ãŸtype/recordã«ã‚ã¨ã‹ã‚‰ protocolã‚’è¿½åŠ ã™ã‚‹ã«ã¯ **extend-type** ã‚’ã¤ã‹ã†.

```clojure
(defprotocol Fly
  (fly [this] "Method to fly"))

(defrecord Bird [name species])

(extend-type Bird
  Fly
  (fly [this] (str (:name this) " flies...")))
```

---

extend-typeã§ã‚ã¨ã‹ã‚‰æ‹¡å¼µã™ã‚‹ã®ã¨defrecordã§ã¯ã˜ã‚ã‹ã‚‰å®šç¾©ã™ã‚‹ã“ã¨ã¯ã‚„ã‚ŠãŸã„ã“ã¨ã¯åŒã˜ã ãŒJavaå®Ÿè£…ãƒ¬ãƒ™ãƒ«ã§ã¯ã‚„ã£ã¦ã„ã‚‹ã“ã¨ãŒã¡ãŒã†.

ref. [clojure extend-type vs deftype and protocol implementation](https://stackoverflow.com/questions/43546225/clojure-extend-type-vs-deftype-and-protocol-implementation)


### extendã¯æ—¢å­˜ã®å‹ã®æ‹¡å¼µã§ã‚ã‚Šæ–°ãŸãªå‹ã®å®šç¾©ã§ã¯ãªã„ {#extendã¯æ—¢å­˜ã®å‹ã®æ‹¡å¼µã§ã‚ã‚Šæ–°ãŸãªå‹ã®å®šç¾©ã§ã¯ãªã„}

extendã¯å‹•çš„ã«æ—¢å­˜ã®å‹ã‚’æ‹¡å¼µã™ã‚‹ã®ã§ã€å‹ã®ç¨®é¡ãŒå¢—ãˆã‚‹ã‚ã‘ã§ã¯ãªã„. æ–°ãŸãªå‹ã®å®šç¾©ã¯defrecordã§å®šç¾©ã™ã‚‹.

Clojureã§ã¯è¦ªå­é–¢ä¿‚ã®ç¶™æ‰¿ã‚’ã‚µãƒãƒ¼ãƒˆã—ãªã„. ãŸã¨ãˆã°OOPã§ã„ã†ã“ã¨ã‚ã®è¦ªã«å…±é€šã®ãƒ‡ãƒ¼ã‚¿ã‚„æŒ¯ã‚‹èˆã„ã‚’æŒã¡å­ã§ä¸€éƒ¨ã‚’å¤‰æ›´ã—ãŸã„å ´åˆ, ï¼‘ã¤ã®ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚’å®šç¾©ã—ã¦ãã‚Œã‚‰ã‚’è¤‡æ•°ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å®šç¾©ã™ã‚‹ä¸­ã«çµ„ã¿è¾¼ã‚€.

Clojureã§éšå±¤é–¢ä¿‚ã‚’è¡¨ç¾ã™ã‚‹ã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹ã§deriveã¨ã„ã†ã‚‚ã®ãŒã‚ã‚‹ãŒã“ã‚Œã¯tagã‚’å¼•æ•°ã«ã¨ã‚‹ã‚‚ã®ã§Recordã¨ã¯ç›´æ¥é–¢ä¿‚ã—ãªã„.


## extend-xæ¯”è¼ƒ(extend vs extend-type vs extend-protocol) {#extend-xæ¯”è¼ƒ--extend-vs-extend-type-vs-extend-protocol}

ã©ã‚Œã‚‚Javaã®ç¶™æ‰¿ã®ä»£æ›¿ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã«ã¤ã‹ã†.

ãã—ã¦ [source](https://github.com/clojure/clojure/blob/clojure-1.10.1/src/clj/clojure/core_deftype.clj#L768) ã‚’ã¿ã‚‹ã¨extendã¯é–¢æ•°ã§ã‚ã‚Š, extend-type/extend-protocolã¯ãƒã‚¯ãƒ­ãªã‚ˆã†ã . ã‚„ã£ã¦ã„ã‚‹ã“ã¨ã¯extendã®å®šç¾©ã‚’æ›¸ãã‚„ã™ãã—ã¦ã„ã‚‹ã«éããªã„. clojuredocsã«ä¹—ã£ã¦ã„ã‚‹å®Ÿä¾‹ã§ãƒã‚¯ãƒ­å±•é–‹å‰ã¨ã‚ã¨ã‚’æ¯”è¼ƒã™ã‚‹ã¨ã‚ˆã„.

-   [extend - clojure.core](https://clojuredocs.org/clojure.core/extend)
-   [extend-type - clojure.core](https://clojuredocs.org/clojure.core/extend-type)
-   [extend-protocol - clojure.core](https://clojuredocs.org/clojure.core/extend-protocol)

---

> If you are supplying the definitions explicitly (i.e. not reusing
> exsting functions or mixin maps), you may find it more convenient to
> use the extend-type or extend-protocol macros.

ã¤ã¾ã‚Šextendã—ãŸã‚‚ã®ã‚’å†åˆ©ç”¨ã—ãªã„ãªã‚‰ã°macroãŒä¾¿åˆ©ã¨ã„ã†ã“ã¨ï¼Ÿ

---

**extend-type** : å˜ä¸€ã®å‹ã«å¯¾ã—ã¦è¤‡æ•°ã®ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã®å®Ÿè£…ã‚’ã‹ã.

> Useful when you are supplying the definitions explicitly inline.

ã¤ã¾ã‚Šï¼‘è¡Œç¨‹åº¦ã®ç°¡æ˜“ãƒ¡ã‚½ãƒƒãƒ‰ã‚’Recordã«ç”Ÿã‚„ã—ãŸã„å ´åˆã¨ã‹.

---

**extend-protocol** : è¤‡æ•°ã®å‹ã«å¯¾ã™ã‚‹å˜ä¸€ã®ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã®å®šç¾©ã‚’ã‹ã.

> Useful when you want to provide several implementations of the same protocol all at once.

protocolè‡ªä½“ãŒæ“ä½œæŠ½è±¡ã§ã‚ã‚Šæ“ä½œã®ã‚°ãƒ«ãƒ¼ãƒ”ãƒ³ã‚°ã‚’ç›®çš„ã«ã—ã¦ã„ã‚‹ã®ãŒextend-typeã¯ãƒ‡ãƒ¼ã‚¿ã‚’èµ·ç‚¹ã«ã¾ã¨ã‚ã‚‹ã‹, extend-protocolã¯ãƒ¡ã‚½ãƒƒãƒ‰ã‚’èµ·ç‚¹ã«ã¾ã¨ã‚ã‚‹ã‹.

---

ref. [extend-type and extend-protocol: different syntax for multi-arity methods](https://groups.google.com/g/clojure/c/DG1mS43rvlo?pli=1)

extend-protocolã¨extend-typeã‚‚ãŠãªã˜ã“ã¨ãŒã§ãã‚‹. è³ªå•è€…ã¯ã‚„ã‚„ã“ã—ã„ã‚ˆã¨ã„ã£ã¦ã„ã‚‹. ã¾ã‚ã©ã¡ã‚‰ã‚‚extendã‹ã‚‰æ´¾ç”Ÿã—ãŸmacroãªã®ã§ã„ã„ã®ã§ã¯ï¼Ÿ


### extend-protocol vs multimethod {#extend-protocol-vs-multimethod}

extend-protocolã¨defmultiã¯åŒã˜ã‚ˆã†ãªã“ã¨ãŒã§ãã‚‹. ãŸã ã—protocolã¯é–¢æ•°ã®ã¯ã˜ã‚ã®å¼•æ•°ã®å‹ã§ã—ã‹å‡¦ç†ã‚’åˆ†å²ã§ããªã„. ã„ã£ã½ã†multimethodã¯å¼•æ•°ã ã‚ã†ãŒãã‚Œã‚’åˆ†è§£ã—ãŸå†…éƒ¨ãƒ‡ãƒ¼ã‚¿é³´ã‚Šè¨ˆç®—çµæœãªã‚Š... ãªã‚“ã§ã‚‚ã§ãã‚‹.

```clojure
;; Multi
(defmulti foo class)

(defmethod foo java.lang.Double [x]
  "A double (via multimethod)")

(defmethod do-a-thing java.lang.Long [x]
  "A long (via multimethod)")


;; Protocol
(defprotocol Bar
  (bar [x] "..."))

(extend-protocol Bar
  java.lang.Double
    (bar [x] "A double (via protocol)")
  java.lang.Long
    (bar [x] "A long (via protocol)"))
```

---

-   refs.
    -   [Clojure multimethods/protocols implementations](https://stackoverflow.com/questions/58427770/clojure-multimethods-protocols-implementations)
    -   [ğŸ’¡Clojure multimehodvs protocols æ¯”è¼ƒ]({{< relref "20220307162746.md#clojure-multimehod-vs-protocols-æ¯”è¼ƒ" >}})


## References {#references}

æƒ…å ±å°‘ãªã„ãªã‚... ç‰¹ã«æ—¥æœ¬èª. æ›¸ç±èª­ã‚€ã®ãŒã„ã„.

-   [ğŸ·ãƒãƒªãƒ¢ãƒ¼ãƒ•ã‚£ã‚ºãƒ ]({{< relref "20220310125619.md" >}})
-   [Clojureã®protocolå®Ÿè·µ - ç´™ç®±](https://boxofpapers.hatenablog.com/entry/2014/02/02/054500)
    -   protocolsã«ã¯æ•°å€‹ã®ifã®ã¿å®šç¾©ã™ã‚Œã°ã„ã„ã¨ã„ã†è€ƒãˆæ–¹, ãªã‚‹ã»ã©.
-   <https://twitter.com/komi_edtr_1230/status/1191374827300409344>
    -   defprotocolãŒPythonã§ã„ã†classã¨ãã®\__init__ã‚’æ„å‘³ã—ã¦ã¦ã€defrecordãŒ\__init__ä»¥é™ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æ„å‘³ã—ã¦ã‚‹ã¨ã—ãŸã‚‰...
-   [Clojureã§ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæŒ‡å‘ã‚’è¡Œã†ã¾ã¨ã‚ - Qiita](https://qiita.com/yosgspec/items/25d392c47b883480e09d)
