+++
title = "ğŸ“Google Cloud Build"
tags = ["WIKI"]
draft = false
+++

-   tags: [ğŸ·GCP]({{< relref "20220311153749.md" >}}) [ğŸ·Docker]({{< relref "20220316081935.md" >}})
-   refs.
    -   æ¦‚è¦: [Cloud Build: ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ CI / CD ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ](https://cloud.google.com/build?hl=ja)
        -   cloudbuild.yamlã®æ›¸ãæ–¹: [åŸºæœ¬çš„ãªãƒ“ãƒ«ãƒ‰æ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ](https://cloud.google.com/build/docs/configuring-builds/create-basic-configuration?hl=ja)
        -   gcloud buildã®ä½¿ã„æ–¹: [ã‚³ãƒ³ãƒ†ãƒŠ ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰](https://cloud.google.com/build/docs/building/build-containers?hl=ja)

---


## Google Cloud Buildã¨ã¯ {#google-cloud-buildã¨ã¯}

GCPä¸Šã§Docker Imageã‚’ä½œæˆã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹. GCPã‚µãƒ¼ãƒ“ã‚¹ã®ã²ã¨ã¤.


## Cloud Buildã®ãƒ“ãƒ«ãƒ‰æ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«(cloudbuild.yml/cloudbuild.json) {#cloud-buildã®ãƒ“ãƒ«ãƒ‰æ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«--cloudbuild-dot-yml-cloudbuild-dot-json}

Cloud Buildã«æ¸¡ã™å„ç¨®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’å®šç¾©ã™ã‚‹. gcloudã®å¼•æ•°ã®ä»£ã‚ã‚Šã«æŒ‡å®š.

**cloudbuild.yaml** ã‚’ä½œæˆ.

```yaml
steps:
- name: 'gcr.io/cloud-builders/docker'
  args: [ 'build', '-t', 'us-central1-docker.pkg.dev/$PROJECT_ID/quickstart-docker-repo/quickstart-image:tag1', '.' ]
images:
- 'us-central1-docker.pkg.dev/$PROJECT_ID/quickstart-docker-repo/quickstart-image:tag1'
```

gcloudã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ **--config** ã¨ã¨ã‚‚ã«æŒ‡å®š.

```sh
$ gcloud builds submit --config cloudbuild.yaml
```

åŸºæœ¬çš„ãªæ›¸ãæ–¹: [ğŸ”—åŸºæœ¬çš„ãªãƒ“ãƒ«ãƒ‰æ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ ](https://cloud.google.com/build/docs/configuring-builds/create-basic-configuration)


## Cloud Build Howto {#cloud-build-howto}


### Dockerfileã‚’ã¤ã‹ã£ã¦Google Cloud Buildã§Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹ {#dockerfileã‚’ã¤ã‹ã£ã¦google-cloud-buildã§dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹}

ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¨DockerfileãŒã‚ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ä»¥ä¸‹ã‚’å®Ÿè¡Œ.

```sh
$ gcloud builds submit --tag {region}/PROJECT_ID/IMAGE_NAME
```

-   regionã¯ gcr.ioã‚„asia.gcr.io(æ—¥æœ¬ã ã¨ã“ã£ã¡ãŒã„ã„).
-   PROJECT_IDã¯GCPã®ã‚‚ã®ã‚’åˆ©ç”¨.
-   IMAGE_NAMEã¯ä»»æ„.


## Cloud Build ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚° {#cloud-build-ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°}

ref. [å…¬å¼Docã®Cloud Buildãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹é›†ã¯ã“ã¡ã‚‰](https://cloud.google.com/build/docs/speeding-up-builds)


### ğŸ”§ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚µãƒ¼ãƒã«é€ä¿¡ã•ã‚Œãªã„ã¨ã {#ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚µãƒ¼ãƒã«é€ä¿¡ã•ã‚Œãªã„ã¨ã}

ã‚µã‚¤ã‚ºå®¹é‡ãŒå¤§ãã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚„ä¸è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã¯è‡ªå‹•ã§é™¤å¤–ã•ã‚Œã‚‹.

```text
Creating temporary tarball archive of 5 file(s) totalling 2.0 KiB before compression.
Some files were not included in the source upload.
```

**.gcloudignore** ã‚’Dockerfileã¨åŒã˜å ´æ‰€ã«ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚‹.

ã‚‚ã—ãã¯ ä»¥ä¸‹ã§globalã«ç„¡åŠ¹åŒ–.

```sh
$ gcloud config set gcloudignore/enabled false
```

ã©ã†ã‚‚æ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«(gcloudbuild.yaml)ã‚’æŒ‡å®šã™ã‚‹ã¨.gcloudignoreã‚’è¦‹ã¦ãã‚Œãªã„. --ignore-fileã§æ˜ç¤ºçš„ã«æŒ‡å®šã™ã‚‹(or ãŠãã‚‰ãæ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ã).

```sh
$ gcloud builds submit --config gcloudbuild.ymal --ignore-file .gcloudignore
```


### ğŸ”§Cloud Buildã®ãƒ“ãƒ«ãƒ‰ã®ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚’ä¸Šã’ãŸã„ {#cloud-buildã®ãƒ“ãƒ«ãƒ‰ã®ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚’ä¸Šã’ãŸã„}

é«˜æ€§èƒ½ãªãƒ“ãƒ«ãƒ‰ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’4ç¨®é¡ã®ä¸­ã‹ã‚‰æŒ‡å®šã§ãã‚‹.

optionã®machine_typeã§æŒ‡å®š.æ•°å€¤ã¯CPUæ•°(8/32 CPUs).

-   machine-type
    -   n1_highcpu_8
    -   n1_higucpu_32
    -   e2_highcpu_8
    -   e2_highcpu_32

é«˜æ€§èƒ½ãªã»ã©ãŠé‡‘ãŒã‹ã‚‹ã“ã¨ã‚‚æ³¨æ„.

ref. [REST Resource: projects.buildsd](https://cloud.google.com/build/docs/api/reference/rest/v1/projects.builds#machinetype)


### ğŸ”§ãƒ“ãƒ«ãƒ‰ãŒå¤±æ•— - no space left on device {#ãƒ“ãƒ«ãƒ‰ãŒå¤±æ•—-no-space-left-on-device}

Google Cloud Buildã‚’å®Ÿè¡Œã—ã¦ã„ã‚‹ç’°å¢ƒã®ç©ºãå®¹é‡ä¸è¶³(ãƒ¡ãƒ¢ãƒªã§ã¯ãªã„).

-   ref. ä»¥ä¸‹ã¯GCEã®Help, å‚è€ƒã¾ã§ã«.
    -   [ãƒ‡ã‚£ã‚¹ã‚¯ã®ç©ºãå®¹é‡ãªã—ã¨ãƒ‡ã‚£ã‚¹ã‚¯ã‚µã‚¤ã‚ºå¤‰æ›´ã®ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°](https://cloud.google.com/compute/docs/troubleshooting/troubleshooting-disk-full-resize?hl=ja)
    -   [æ°¸ç¶šãƒ‡ã‚£ã‚¹ã‚¯ã®ã‚µã‚¤ã‚ºã®å¤‰æ›´](https://cloud.google.com/compute/docs/disks/resize-persistent-disk?hl=ja)
