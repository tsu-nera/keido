+++
title = "ğŸ“Clojure Integrant"
tags = ["Clojure", "WIKI"]
draft = false
+++

-   up: [Clojure: çŠ¶æ…‹ç®¡ç†ã¨ã‚·ã‚¹ãƒ†ãƒ ]({{< relref "20220211142329.md#clojure-çŠ¶æ…‹ç®¡ç†ã¨ã‚·ã‚¹ãƒ†ãƒ " >}})
-   refs.
    -   [weavejester/integrant: Micro-framework for data-driven architecture](https://github.com/weavejester/integrant)
    -   made by [ğŸ‘¨James Reeves(@weavejester)]({{< relref "20220320183317.md" >}}).


## Clojure: Integrantã¨ã¯ {#clojure-integrantã¨ã¯}

ãƒ‡ãƒ¼ã‚¿é§†å‹•è¨­è¨ˆã«ã‚ˆã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã™ã‚‹ãŸã‚ã®ãƒã‚¤ã‚¯ãƒ­ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯.

[Dependency Ingection]({{< relref "20220310114456.md" >}}) ã‚’Clojureã§å®Ÿç¾.

è¨­å®šãƒ‡ãƒ¼ã‚¿ã«å¯¾ã™ã‚‹åˆæœŸåŒ–é–¢æ•°ã‚’å®šç¾©ã§ã, è¨­å®šãƒ‡ãƒ¼ã‚¿ã®å®šç¾©ã‹ã‚‰å®Ÿä½“ã‚’ç”Ÿæˆ.


### Usage {#usage}

-   integrant
    -   **configuration map** ã‚’ã‚‚ã¨ã«ç”Ÿæˆã•ã‚Œã‚‹micro-serviceã®1ã¤ã®å˜ä½.
-   configuration map
    -   keyã®å®šç¾©ã‚’ã¾ãšã™ã‚‹. ã“ã‚Œã¯å…·ä½“çš„ãªå®Ÿè£…ã¸ã¨åˆæœŸåŒ–ã•ã‚Œã‚‹å…¥åŠ›æƒ…å ±.
    -   Clojureã®mapã¨ã—ã¦è¡¨ç¾ã™ã‚‹ã‹EDNãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã«å®šç¾©ã™ã‚‹.
    -   configuration mapåŒå£«ã¯ **ig/ref** ã§ å‚ç…§ã™ã‚‹ã“ã¨ãŒã§ãã‚‹.
-   ig/init-key ã§ integrant serviceã®åˆæœŸåŒ–ã«ãŠã‘ã‚‹ãƒ‡ãƒ¼ã‚¿ã¨é–¢æ•°ã‚’å®šç¾©.
-   ig/halt-key!ã§integrant serviceã®init-keyã®å®šç¾©ã‚’ç ´æ£„ã™ã‚‹é–¢æ•°ã‚’å®šç¾©.
-   ig/initã«configuration mapã‚’æ¸¡ã™ã“ã¨ã§, ä¾å­˜é–¢ä¿‚ã«å¾“ã£ã¦ integrant ã‚’åˆæœŸåŒ–.
-   init/halt!ã§ ç ´æ£„.

<!--listend-->

```clojure
(defmethod ig/init-key :handler/greet [_ {:keys [name]}]
  (fn [_] (resp/response (str "Hello " name))))
```

-   {:keys [name]}ã¯Clojure åˆ†é…æŸç¸›ã®è¨˜æ³•.
    -   ref: [ğŸ“Destructuring]({{< relref "20220116094551.md#clojure-åˆ†é…æŸç¸›--destructuring" >}})
-   keyã« ::hogeã¿ãŸã„ãª 2ã¤ã®ã‚³ãƒ­ãƒ³ã‚’ã¿ã‹ã‘ã‚‹. ::hogeã¯ :(namespace)/hogeã®æ„å‘³.
    -   REPLã§è©•ä¾¡ã™ã‚‹ã¨ã‚ã‹ã‚‹, reader syntax.


### Usage: Integrant suspend/resume {#usage-integrant-suspend-resume}

<https://github.com/weavejester/integrant#suspending-and-resuming>

Integrantã¯initã¨halt, ã¤ã¾ã‚Šã‚·ã‚¹ãƒ†ãƒ ã®é–‹å§‹ã¨çµ‚äº†ã®æ©Ÿèƒ½ã‚’æä¾›ã™ã‚‹.

suspend/resumeã¯ä¸»ã« **é–‹ç™ºç”¨** ã§ã‚ã‚‹. ãã—ã¦ä½¿ã„ã“ãªã™ã«ã¯atomã¨delayã‚’ã¤ã‹ã†ã¨ã„ã†ã²ã¨å·¥å¤«ã‚’åŠ ãˆã‚‹.

Integrantã®è€ƒãˆæ–¹ã¨ã—ã¦namespaceã«atomã‚’bindingã—ãªã„. ãã®ä»£ã‚ã‚Šã« init-keyã®ä¸­ã§ atomã‚’å®£è¨€ã—ã¦è¿”ã‚Šå€¤ã®mapã«bindingã™ã‚‹.


## Integrant-REPL {#integrant-repl}

Integrantã§[Reloaded Workflow]({{< relref "20220117205249.md#reloaded-workflow" >}})ã‚’ã™ã‚‹ãŸã‚ã®è£œåŠ©ãƒ©ã‚¤ãƒ–ãƒ©ãƒª. Integrantã¨åŒã˜weavejesterã•ã‚“ãŒä½œæˆ.

<https://github.com/weavejester/integrant-repl>

ã‚³ãƒ¼ãƒ‰è‡ªä½“ã¯å°ã•ãã‚·ãƒ³ãƒ—ãƒ«ãªã®ã§ãªã«ã‚’ã‚„ã£ã¦ã„ã‚‹ã®ã‹ã¯ã‚½ãƒ¼ã‚¹è¦‹ã‚‹ã®ãŒæ—©ã„ã‹ã‚‚.


### <span class="org-todo todo _">ğŸ’¡</span> systemã‚’replã‹ã‚‰ã¿ã‚‹ {#systemã‚’replã‹ã‚‰ã¿ã‚‹}

å€‹äººçš„ã«å¼·ã„ã¨ãŠã‚‚ã†Tips. integrant.replã¯integrantã§åˆæœŸåŒ–ã—ãŸsystemã‚’ [alter-var-root]({{< relref "20220116080418.md#def-macro-alter-var-rootã«ã‚ˆã‚‹varã®å†å®šç¾©" >}}) å¤‰æ•°ã«bindã—ã¦ã„ã‚‹. ã™ã‚‹ã¨, ã“ã®systemã®å¤‰æ•°ã‚’è¦—ã„ã¦ã—ã¾ãˆã°å‹•ä½œã—ã¦ã„ã‚‹ã‚·ã‚¹ãƒ†ãƒ ã®ä¸­èº«ãŒã‚¹ã‚±ã‚¹ã‚±ã®ã¾ã‚‹ã¿ãˆ.

integrantãŒè¦ã¯ã‚¢ãƒ—ãƒªã®ãªã‹ã§atomãªã©ã®çŠ¶æ…‹ã‚’ãƒãƒ©ãƒãƒ©ã«å®£è¨€ã™ã‚‹ã®ã§ã¯ãªãã¦ä¸€ã¤ã®rootã¨ãã®ãƒ„ãƒªãƒ¼ã«ã¾ã¨ã‚ã¾ã—ã‚‡ã†ã¨ã„ã†è¨­è¨ˆãªã®ã§, ã“ã®ä¸­ã‚’ã¿ã‚Œã°ã‚·ã‚¹ãƒ†ãƒ ã®å…¨ã¦ãŒè¦‹ã‚Œã‚‹.

```clojure
(require '[integrant.repl.state :refer [config system]])
```


### <span class="org-todo todo _">âœ…</span> CIDERé€£æº {#cideré€£æº}

[Emacs CIDER]({{< relref "20220316151158.md#emacs-cider" >}}) ã§ M-x cider-ns-refreshã®å‰å¾Œã«suspendã¨resumeã‚’hookã•ã›ã‚‹ã¨æ°—è»½ã«ã‚·ã‚¹ãƒ†ãƒ ã‚’reset.

.dir-locals.elã«ä»¥ä¸‹ã‚’è¨˜è¼‰.

```elisp
((clojure-mode . ((cider-ns-refresh-before-fn . "integrant.repl/suspend")
                  (cider-ns-refresh-after-fn  . "integrant.repl/resume"))))
```


## ğŸ’¡Integrantãƒˆãƒ”ãƒƒã‚¯ {#integrantãƒˆãƒ”ãƒƒã‚¯}


### ğŸ’¡è€ƒå¯Ÿ: Integrantã§çŠ¶æ…‹ã‚’ç®¡ç†ã™ã‚‹ã¨ã„ã†ã“ã¨(as State Management) {#è€ƒå¯Ÿ-integrantã§çŠ¶æ…‹ã‚’ç®¡ç†ã™ã‚‹ã¨ã„ã†ã“ã¨--as-state-management}

Clojureã®ä¸–ç•Œã§ã¯, æ™®é€šã¯çŠ¶æ…‹ã‚’atomã§ç®¡ç†ã™ã‚‹.

Integrantã‚’å°å…¥ã™ã‚‹ã“ã¨ã§, å„namespaceã«æ•£ã‚‰ã°ã‚‹atomã§å®£è¨€ã•ã‚ŒãŸçŠ¶æ…‹ã‚’systemã¨ã„ã†ã²ã¨ã¤ã®çŠ¶æ…‹ã«ç´ã¥ã‘ã¦ã¾ã¨ã‚ã‚‹ã“ã¨ãŒã§ãã‚‹. ãã—ã¦ã“ã®ãƒ„ãƒªãƒ¼æ§‹é€ ã§çŠ¶æ…‹ã‚’ç®¡ç†ã™ã‚‹ã‹ã‚‰ã“ãã‚·ã‚¹ãƒ†ãƒ ã®åœæ­¢ã‚„å†èµ·å‹•ãŒç”¨æ„ã«ã§ãã‚‹.

é€†ã«è¨€ã†ã¨, Integrantã‚’åˆ©ç”¨ã™ã‚‹ã¨ã„ã†ã“ã¨ã¯, namespaceã§atomã‚’å®£è¨€ã—ãªã„ã¨ã„ã†ã“ã¨.

---

[Integrant: how to store and access the running system? : Clojure](https://www.reddit.com/r/Clojure/comments/ar87te/integrant_how_to_store_and_access_the_running/)

> Systems in Integrant are intended to be autonomous.

> Anyway, my point is that it seems to me Integrant still requires a whole app buy-in in the sense that, unlike with Mount, you have to thread all your state through a single entry-point.

systemã¯threadã§å‹•ä½œã™ã‚‹å†å¸°ãƒ—ãƒ­ã‚»ã‚¹. ã—ã‹ã—ã“ã‚Œã¯Integrantã¨è¨€ã†ã‚ˆã‚Šã‚‚é–¢æ•°å‹ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã®ã‚¤ãƒ‡ã‚£ã‚ªãƒ .

> Only constants should be global.

å®šæ•°ã®ã¿ãŒå‚ç…§å¯èƒ½ã§ã‚ã‚ŠçŠ¶æ…‹ã¯éš ã•ã‚Œã¦ã„ã‚‹ã¨ã„ã†è€ƒãˆ(debugé™¤ã).


### ğŸ’¡è€ƒå¯Ÿ: Java Command Patternã‹ã‚‰ã®ã‚¢ãƒŠãƒ­ã‚¸ãƒ¼ {#è€ƒå¯Ÿ-java-command-patternã‹ã‚‰ã®ã‚¢ãƒŠãƒ­ã‚¸ãƒ¼}

ã‚¯ãƒ©ã‚¹ã¨ã„ã†ã‚‚ã®ã‚’å˜ãªã‚‹æŠ½è±¡ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã¨æ‰ãˆã‚‹ã¨, ã‚¯ãƒ©ã‚¹ã«ã¯å±æ€§ã¨ã—ã¦ã®å€¤ã¨é–¢æ•°å€¤ã®é›†åˆã§ã‚ã‚Š, ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã¯ãã‚Œã‚’ãƒ¡ãƒ¢ãƒªä¸Šã«é ˜åŸŸç¢ºä¿ã—ãŸçŠ¶æ…‹.

ig/init-keyã§ã‚„ã£ã¦ã„ã‚‹ã“ã¨ã¯å€¤ã¨ãã®åˆæœŸåŒ–é–¢æ•°ã®pairã®bindingã§ã‚ã‚Š, ig/init-keyã§å®šç¾©ã—ãŸpairã®é›†åˆã‚’ig/initã§ã¾ã¨ã‚ã¦åˆæœŸåŒ–ã—ã¦ã„ã‚‹.

ãã†ã™ã‚‹ã¨, ig/init-keyã§åˆæœŸåŒ–ã—ãŸãã‚Œãã‚Œã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ï¼‘ã¤ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã« bindingã—ã¦ç®¡ç†ã—ã¦ã„ã‚‹ã‚ˆã†ã«ã‚‚ã¿ãˆã‚‹. ç®¡ç†ã¨ã„ã†ã“ã¨ã§, suspend, resume, haltã¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ [Command Pattern]({{< relref "20220309184220.md#command-pattern" >}}) ã§æ‰±ã†ã‚ˆã†ãªã‚‚ã®ã¨ã—ã¦æ‰ãˆã‚Œã°ç´å¾—ãŒã„ã.

(ã‚¢ãƒŠãƒ­ã‚¸ãƒ¼ã¨ã—ã¦é¡æ¨ã—ãŸã ã‘ã§å®Ÿè£…ã‚’èª­ã‚“ã§ã¯ãªã„...å¾Œã§èª­ã‚€).


### ğŸ’¡è€ƒå¯Ÿ: Integrant Rationale cf. Component {#è€ƒå¯Ÿ-integrant-rationale-cf-dot-component}

Clojure Component ã®ä»£æ›¿ã‚’æ„è­˜ã—ã¦, ã¨ãã«ComponentãŒä¾å­˜é–¢ä¿‚ã‚’ãƒ—ãƒ­ã‚°ãƒ©ãƒ å†…(Clojure Source Code)ã§ç®¡ç†ã™ã‚‹ãŒ, Integrantã¯EDNã§ç®¡ç†ã™ã‚‹ã¨ã“ã‚ãŒã“ã ã‚ã‚Šãƒã‚¤ãƒ³ãƒˆ.

ã™ãªã‚ã¡Integrantã¯Clojure Mapã§ã‚‚EDNã§ã‚‚ã©ã¡ã‚‰ã§ã‚‚æ§‹æˆå®šç¾©ã§ãã‚‹ãŒ, è¨­è¨ˆå‹•æ©Ÿã‹ã‚‰ã„ãˆã°EDNã¤ã‹ãˆã‚ˆï¼ã¨ã„ã†ã“ã¨ã‹ãªï¼Ÿ


### ğŸ’¡è€ƒå¯Ÿ: Component/Mountã¨Integrantã®æ±ºå®šçš„é•ã„ã¯OOP vs FP {#è€ƒå¯Ÿ-component-mountã¨integrantã®æ±ºå®šçš„é•ã„ã¯oop-vs-fp}

Componentã‚„Mountã‚’ä½¿ã£ãŸã“ã¨ãŒãªã„ã®ã§ä»¥ä¸‹ã¯ãƒªãƒ³ã‚¯å…ˆã‹ã‚‰ã®ç†è§£.

[Integrant: an alternative to Component and Mount : Clojure](https://www.reddit.com/r/Clojure/comments/5gvhi2/integrant_an_alternative_to_component_and_mount/)

Componentã‚„Mountã¯çŠ¶æ…‹ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å‚ç…§ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã®ã§, é–¢æ•°ã®å¼•æ•°ã¨ã—ã¦ã‚‚ã‚‰ã†å¿…è¦ãŒãªã„.

Integrantã¯çŠ¶æ…‹ãŒãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ä¸­ã«éš ã•ã‚Œã¦ã„ã¦è‡ªç”±ã«å‚ç…§ã§ããªã„. ãã®ãŸã‚ãã®çŠ¶æ…‹ã«å¯¾ã™ã‚‹æ“ä½œã¯é–¢æ•°ã®å¼•æ•°ã¨ã—ã¦ã‚‚ã‚‰ã£ã¦å¤‰åŒ–ã—ãŸå€¤ã‚’è¿”ã™ã‚ˆã†ã«æ›¸ã. ã¾ãŸã¯handlerã®å®šç¾©ã¨ã—ã¦çŠ¶æ…‹ã¨ãã‚Œã«å¯¾ã™ã‚‹æ“ä½œã‚’1ã¤ã«bindingã™ã‚‹.

Webãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ãªã‚‰ãŸãã•ã‚“ã®ã‚µãƒ³ãƒ—ãƒ«ã‚’è¦‹ãªãŒã‚‰è‡ªç„¶ã¨ã“ã®åˆæœŸåŒ–ã§çŠ¶æ…‹ã¨é–¢æ•°ã‚’handlerã¨ã—ã¦bindingã™ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã«å¾“ãˆã°ã„ã„ã‚‚ã®ã®, webã¨ã¯é–¢ä¿‚ãªãå˜ã«integrantã‚’ä½¿ãŠã†ã¨ã—ãŸã¨ã, ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ãŒãªã„ã®ã§è‡ªåˆ†ã®æµå„€ã§å®Ÿè£…ã—ãŒã¡, æœ¬è³ªã‚’è€ƒãˆã‚ˆã†.

åˆæœŸåŒ–æ™‚ã«è‡ªå‰ã§namespaceã«atomã«ä¿å­˜ã—ã¦ãŠãæ–¹æ³•ã¯ãã‚‚ãã‚‚ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§çŠ¶æ…‹ã‚’ç®¡ç†ã™ã‚‹è€ƒãˆã«åã™ã‚‹ã‚¢ãƒ³ãƒãƒ‘ã‚¿ãƒ¼ãƒ³.

Integrantã¯é–¢æ•°å‹ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°(FP)ã®è€ƒãˆã«è¿‘ã„. ä¸€æ–¹Componentã®è€ƒãˆã¯ã‚¯ãƒ©ã‚¹ã‚„OOPã«è¿‘ã„.

ã¨ãã«FPã§ã‚·ã‚¹ãƒ†ãƒ ã‚’æ§‹ç¯‰ã™ã‚‹ã¨å†ªç­‰æ€§ã‚’ç²å¾—ã™ã‚‹ã“ã¨ãŒã§ã, ã“ã‚ŒãŒé–‹ç™ºæ™‚ã«ã¨ãã«å½¹ã«ç«‹ã¤(cf. [Reloaded Workflow]({{< relref "20220117205249.md#reloaded-workflow" >}})). Componentã¯è‡ªåˆ†ãŒåˆæœŸåŒ–æ¸ˆã¿ã‹ã©ã†ã‹ã¯Componentè‡ªèº«ã—ã‹ã‚ã‹ã‚‰ãªã„.

-   [Componentã¨Integrantã®é•ã„ - ayato-p](https://scrapbox.io/ayato-p/Component%E3%81%A8Integrant%E3%81%AE%E9%81%95%E3%81%84)
    -   <https://twitter.com/athos0220/status/931003506638458882>


### ğŸ’¡Integrantã¨Ring Handlerã®2ã¤ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ {#integrantã¨ring-handlerã®2ã¤ã®ãƒ‘ã‚¿ãƒ¼ãƒ³}

-   refs:
    -   [Integrantã§Ringãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’ã©ã†æ‰±ã†ã‹ - ayato-p](https://scrapbox.io/ayato-p/Integrant%E3%81%A7Ring%E3%83%8F%E3%83%B3%E3%83%89%E3%83%A9%E3%83%BC%E3%82%92%E3%81%A9%E3%81%86%E6%89%B1%E3%81%86%E3%81%8B)
    -   [Passing dependencies into ring handlers ... on request map, or \`partial\`ed into the handler?](https://clojureverse.org/t/passing-dependencies-into-ring-handlers-on-request-map-or-partial-ed-into-the-handler/8540)

2ã¤ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒã‚ã‚‹.

-   ã™ã¹ã¦ã®Ringãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨ã—ã¦æ‰±ã†.
-   ãƒ«ãƒ¼ã‚¿ãƒ¼éƒ¨åˆ†ã¾ã§ã‚’ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«ã—ã¦ã€Ringãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã¯ãŸã ã®é–¢æ•°ã¨ã—ã¦æ‰±ã†.

[Component/Mountã¨Integrantã®æ±ºå®šçš„é•ã„ã¯OOP vs FP](#è€ƒå¯Ÿ-component-mountã¨integrantã®æ±ºå®šçš„é•ã„ã¯oop-vs-fp) ã®è­°è«–ã«ä¼¼ã¦ã„ã‚‹.


## <span class="org-todo todo _">ğŸ”—</span> References {#references}

-   [Enter Integrant: A Micro-framework for Data-Driven Architecture (James Reeves, 2017) - YouTube](https://www.youtube.com/watch?v=tiWTpp_DPIQ&t=2276s)
    -   ä½œè€…ã«ã‚ˆã‚‹ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å‹•ç”».
-   [Integrantå…¥é–€(1) - Integrantã®åŸºæœ¬ - ayato-p](https://scrapbox.io/ayato-p/Integrant%E5%85%A5%E9%96%80(1)_-_Integrant%E3%81%AE%E5%9F%BA%E6%9C%AC)
-   [ã¯ã˜ã‚ã¦ã®Duct - Uzabase Tech](https://tech.uzabase.com/entry/2018/04/03/115236)
    -   integrantã«ã¤ã„ã¦ã‚‚æ›¸ã‹ã‚Œã¦ã‚‹.
