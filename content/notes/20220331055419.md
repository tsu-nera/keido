+++
title = "ğŸ“Clojure Exception: ä¾‹å¤–"
tags = ["WIKI"]
draft = false
+++

Clojureã«ãŠã‘ã‚‹ä¾‹å¤–å‡¦ç†ã‚„ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã«ã¤ã„ã¦ã¾ã¨ã‚.

-   up: [ğŸ“‚Clojure Core Languages]({{< relref "20220112142936.md" >}})
-   links.
    -   [Clojure - Clojureã‚’å­¦ã¼ã† - ãƒ•ãƒ­ãƒ¼åˆ¶å¾¡](https://japan-clojurians.github.io/clojure-site-ja/guides/learn/flow#_%E4%BE%8B%E5%A4%96)
-   refs.
    -   [ğŸ”–Exceptions]({{< relref "20220305075933.md#ä¾‹å¤–-exceptions" >}})
    -   [ğŸ“Clojure Java Interop]({{< relref "20220117172324.md" >}})
    -   [ğŸ“Java Exception: ä¾‹å¤–]({{< relref "20220731122944.md" >}})


## Clojure Exception Basics {#clojure-exception-basics}

Javaã®ä»•çµ„ã¿ã‚’ä½¿ã†. ã—ãŸãŒã£ã¦Javaã®çŸ¥è­˜ãŒã‚ã‚‹ã¨better.

Clojureã¯ãã‚‚ãã‚‚[ğŸ”–æ¤œæŸ»ä¾‹å¤–]({{< relref "20220305075933.md#æ¤œæŸ»ä¾‹å¤–" >}})ã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒå¼·åˆ¶ã•ã‚Œãªã„. æœ¬å½“ã«å¿…è¦ãªã¨ãã®ã¿ã«æ›¸ã‘ã°ã„ã„. ãã®ãŸã‚Javaã‚³ãƒ¼ãƒ‰ã®ã‚ˆã†ã«ãƒ¡ãƒ³ãƒ†ãŒä¸è‡ªç”±ãªæ±šã„ã‚³ãƒ¼ãƒ‰ã«ãªã‚‰ãªã„.

Clojureã®ä¾‹å¤–ã«ã¤ã„ã¦æ›¸ã‹ã‚Œã¦ã„ã‚‹è¨˜äº‹ã¯å°‘ãªã„ã‚‚ã®ã®, ä»¥ä¸‹ã®è¨˜äº‹ã¯ã‘ã£ã“ã†ãªåˆ†é‡ã ã‘ã©Clojureã®ä¾‹å¤–ã®è©±é¡Œã‚’ç¶²ç¾…çš„ã«ã„ã‚ã„ã‚æ›¸ã„ã¦ã‚‹.

[Exceptions in Clojure](https://grishaev.me/en/clj-book-exceptions/)

ä¾‹å¤–ã‚’ãã‚‚ãã‚‚ç™ºç”Ÿã•ã›ãªã„ã‚ˆã†ã«è¡¨æ˜ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°[ğŸ“Clojure spec]({{< relref "20220323030746.md" >}})ã‚‚æ¤œè¨.


## Clojure Exception Syntax {#clojure-exception-syntax}

Javaã®ã‚ˆã†ã«try/catch/finallyãŒåˆ©ç”¨ã§ãã‚‹.

```clojure
(try
  (/ 2 1)
  (catch ArithmeticException e
    "divide by zero")
  (finally
    (println "cleanup")))
```

throwã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹ã§ä¾‹å¤–ã‚’å¼•æ•°ã«ã¨ã‚Šä¾‹å¤–ã‚’ç™ºç”Ÿã•ã›ã‚‹.

-   ä¾‹å¤–ã¯Javaã®ã‚¯ãƒ©ã‚¹ã§ä½œæˆã§ãã‚‹(Exception. )
-   Clojureã®è¨˜æ³•ã§ex-infoã¯messageã¨mapã‚’å—å–ãƒªä¾‹å¤–ã‚’ç™ºç”Ÿã•ã›ã‚‹.
-   Clojureã®è¨˜æ³•ã§ex-dataã¯ex-infoã§å…¥åŠ›ã—ãŸmapã‚’å±•é–‹ã™ã‚‹.

<!--listend-->

```clojure
(try
  (throw (ex-info "bad" {:a 1 :b 2}))
  (catch clojure.lang.ExceptionInfo e
    (prn "caught" e)))
```

ex-messageãŒè¡Œãƒ¡ãƒƒã‚»ãƒ¼ã‚¸, ex-dataãŒè©³ç´°æƒ…å ±.

```clojure
(try
  (let [response (http/post
                   "http://localhost:8080/v1/leads"
                   {:form-params {:foo "somethingBad"}})]
    (log/info "This is the response" response))
  (catch Exception e
    (log/error (str "Oops! " (ex-message e)))
    (log/error (str "Because! " (ex-data e))))
```


## with-open: ãƒªã‚½ãƒ¼ã‚¹é–‹æ”¾ {#with-open-ãƒªã‚½ãƒ¼ã‚¹é–‹æ”¾}


## é€£ç¶šçš„ãªãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£å‘¼ã³å‡ºã—ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã©ã†ã™ã‚‹ã‹å•é¡Œ {#é€£ç¶šçš„ãªãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£å‘¼ã³å‡ºã—ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã©ã†ã™ã‚‹ã‹å•é¡Œ}

Clojureã§ã‚·ã‚¹ãƒ†ãƒ ã®å¤–éƒ¨ã¨ã‚„ã‚Šã¨ã‚Šã‚’ã™ã‚‹ã¨ãã«ï¼Œãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã£ã¦ä¸€é€£ã®å‹•ä½œã‚’ã™ã‚‹ã‚·ãƒ¼ãƒ³ãŒã‚ˆãã‚ã‚‹. ã“ã®ã¨ã, ä¾‹å¤–å‡¦ç†ã‚’ã©ã†ã™ã‚‹ã‹å•é¡Œ. ã¨ãã«RESP APIå‘¼ã³å‡ºã—ã‚„DBã¨ã®é€šä¿¡ãªã©ã§é »ç™ºã™ã‚‹.

```clojure
(try
   (let [value (func-that-throws)]
      (act-on-value value))
   (catch Exception e
      (log/error e "func-that-throws failed")))
```

threading-macroã‚’ã‚«ã‚¹ã‚¿ãƒ ã™ã‚‹ã‚ˆã†ã«Railway oriented programming?ã§è¨˜è¿°ã™ã‚‹ã»ã†ã»ã†ã¨, try-catchã¨ifã‚’ç”¨ã„ã¦ã‚´ãƒªã‚´ãƒªå‡¦ç†ã™ã‚‹æ–¹æ³•ãŒã‚ã‚‹ã‚ˆã†ã .

ref. [Clojure ã¨ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° at 2021 - Qiita](https://qiita.com/MeguruMokke/items/530159edf0c41a9df6b1)

æ‰‹ç¶šãçš„ãªå‡¦ç†ã‚’letã«ãšã‚‰ãšã‚‰æ›¸ã„ã¦ã„ãã®ã¯ã©ã†ã‚‚é•å’Œæ„ŸãŒã‚ã‚‹(å€‹äººçš„ãªæ„Ÿæƒ³). ãã†ã™ã‚‹ã¨ã‚¹ãƒ¬ãƒƒãƒ‡ã‚£ãƒ³ã‚°ãƒã‚¯ãƒ­ã§bodyã«æ›¸ã„ã¦ã„ãã‚¹ã‚¿ã‚¤ãƒ«ã¯ã‚ˆã‚ŠClojureã‚‰ã—ãã¦ã‚³ãƒ¼ãƒ‰ã®è¦‹ãŸç›®ã¯ã‚ˆã„. ã—ã‹ã—ä»•çµ„ã¿ãŒdefaultã§Clojureã«çµ„ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„ã®ã§æ±ç”¨çš„ã§ã¯ãªã„. æ‰‹ç¶šããŒæ•°å€‹ã«éããªã„ãªã‚‰ã°tryã¨letã¨if, ãã†ã§ãªã‘ã‚Œã°railwayã‚’ä½¿ãˆã°ã„ã„ã‹ãª.


### Railway oriented programming(é‰„é“æŒ‡å‘ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°) {#railway-oriented-programming--é‰„é“æŒ‡å‘ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°}

é‰„é“æŒ‡å‘ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã¨ã¯ã€F# ã§æœ‰åã ã£ãŸãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã‚¹ã‚¿ã‚¤ãƒ«. é–¢æ•°ã®è¿”ã‚Šå€¤ã«æ­£å¸¸ç³»ã®çµæœ result ã¨ãã‚Œä»¥å¤–ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ err ã®ã‚¿ãƒ—ãƒ« [result, err] ã‚’æƒ³å®šã—ã€å®Ÿè¡Œãƒ•ãƒ­ãƒ¼ã®å„ãƒ—ãƒ­ã‚»ã‚¹ã§å¾—ã‚‰ã‚Œã‚‹ err ãŒ nil ã§ãªã„æ™‚ Early-Return ã‚’ã‹ã‘ã‚‹æ–¹å¼. (Scalaã‚„Haskellã§ã‚‚åˆã£ãŸæ°—ãŒã™ã‚‹).

-   refs.
    -   [Railway oriented programming, clojure and exception handling: why and how?](https://medium.com/appsflyer/railway-oriented-programming-clojure-and-exception-handling-why-and-how-89d75cc94c58)

---

ã•ã‚‰ã«, Javaã®é–¢æ•°ã‚’å‘¼ã³å‡ºã™ã¨ãã«ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒä¾‹å¤–ã‚’æŒ™ã’ãšã«Nullã‚’è¿”ã™ã¨ãã¯ **some->** ã¨ã„ã†ã‚¹ãƒ¬ãƒƒãƒ‡ã‚£ãƒ³ã‚°ãƒã‚¯ãƒ­ã‚’ä½¿ã†æ–¹æ³•ã‚‚Clojureã®ã‚¬ã‚¤ãƒ‰ã«ã‚ã£ãŸ.

ref. [some-> - Threading Macros Guide](https://clojure.org/guides/threading_macros#_some_some_and_cond)


### try-catch and if-let {#try-catch-and-if-let}

tryã¨letã‚’ã¤ã‹ã£ã¦æ„šç›´ã«æ›¸ã. ã‚³ãƒ¼ãƒ‰ã¯æ±šããªã‚‹ã‚‚ã®ã®å®Ÿè£…ã‚‚ç†è§£ã‚‚ã“ã£ã¡ã¯å®¹æ˜“.

ref. [ğŸ”if-let ã¯å‡¦ç†ã®çµæœã«ã‚ˆã‚‹åˆ†å²ã§ã¤ã‹ã†]({{< relref "20220116083656.md#if-let-ã¯å‡¦ç†ã®çµæœã«ã‚ˆã‚‹åˆ†å²ã§ã¤ã‹ã†" >}})

---

try-letã¨ã„ã†ãƒã‚¯ãƒ­ã‚’æä¾›ã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚‚ã‚ã‚‹.

-   refs.
    -   [clojure - How to handle exceptions that occur in let bindings or body - Stack Overflow](https://stackoverflow.com/questions/20335760/how-to-handle-exceptions-that-occur-in-let-bindings-or-body)
    -   [GitHub - rufoa/try-let: Better exception handling for Clojure let expressions](https://github.com/rufoa/try-let)


### ğŸ¤”ãã‚‚ãã‚‚Consistentã‚’è€ƒæ…®ã—ã¦ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã™ã‚‹ã¹ããªã®ã‹ {#ãã‚‚ãã‚‚consistentã‚’è€ƒæ…®ã—ã¦ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã™ã‚‹ã¹ããªã®ã‹}

Clojureã¯ä¸¦åˆ—ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã‚’å¼·ãæ„è­˜ã—ã¦ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã¨ã„ã†æ¦‚å¿µã‚‚ã‚ã‚‹ãã‚‰ã„ãªã®ã§ä¸€é€£ã®ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®é€”ä¸­ã§ã‚¨ãƒ©ãƒ¼ãŒå¤±æ•—ã—ãŸã‚‰ãã®ä¸€é€£ã®å‡¦ç†è‡ªä½“ãã®ã‚‚ã®ã‚’å¤±æ•—ã•ã›ã‚‹ã‚ˆã†ã«ä½œã‚‹ã¹ããªã®ã‹ã‚‚ã—ã‚Œãªã„. ã¤ã¾ã‚ŠConsistent, ä¸€è²«æ€§ã¨ã„ã†æ¦‚å¿µ.


## slingshot: Enhanced throw and catch for Clojure {#slingshot-enhanced-throw-and-catch-for-clojure}

ref. [GitHub - scgilardi/slingshot](https://github.com/scgilardi/slingshot)

Clojureã¯åŸºæœ¬çš„ã«Javaã®ä¾‹å¤–ã®ä»•çµ„ã¿ã‚’åˆ©ç”¨ã™ã‚‹ãŒ, ã•ã‚‰ã«Clojureã«åˆã‚ã›ã¦ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ãŸãƒ©ã‚¤ãƒ–ãƒ©ãƒª.

ãŸã¨ãˆã° [clj-http]({{< relref "20220209102028.md#clj-http" >}}) ã§ã¯ HTTP ResponseãŒæ­£å¸¸çµ‚äº†ä»¥å¤–ã®å ´åˆã¯ã“ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è¿”ã™ãŸã‚, slingshotã«åˆã‚ã›ãŸã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒæœŸå¾…ã•ã‚Œã‚‹.

**try+** ã¨ **thorw+** ã¨ã„ã†ï¼’ã¤ã®ãƒã‚¯ãƒ­ã‚’æä¾›.


## Clojureä¾‹å¤–ã®ãƒˆãƒ”ãƒƒã‚¯ {#clojureä¾‹å¤–ã®ãƒˆãƒ”ãƒƒã‚¯}


### âœ…REPLã§ä¾‹å¤–ã¨æˆ¦ã† {#replã§ä¾‹å¤–ã¨æˆ¦ã†}

\*eã¨pstã‚’è¦šãˆã‚ˆã†.

**clojure.core/\*e** ã¨ã„ã†å¤‰æ•°ã«æœ€å¾Œã«ç™ºç”Ÿã—ãŸã‚¨ãƒ©ãƒ¼ãŒæ ¼ç´ã•ã‚Œã¦ã„ã‚‹. clojure.coreãªã®ã§REPLã‹ã‚‰\*eã‚’å©ã‘ã°ã™ãã«å‚ç…§ã§ãã‚‹.

clojure.repl/pstã¯ \*eã®ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’å‡ºåŠ›ã™ã‚‹. ã¾ãŸclojure.repl/root-causeã¯ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ã®rootã¨ãã®éšå±¤ã‚’æŒ‡å®šã—ã¦å‡ºåŠ›.

```clojure
(require '[clojure.repl :refer :all])

(pst)
(root-cause (pst) 3)
```


### <span class="org-todo todo _">âš™</span> pcoll pattern on Clojure {#pcoll-pattern-on-clojure}

é–¢æ•°å‘¼ã³å‡ºã—ã‚’try-catchã§åŒ…ã‚€æ–¹æ³•.

```clojure
(defn pcall [f & args]
  (try
    [true (apply f args)]
    (catch Exception e [false e])))
```

ref. [pcoll pattern in clojure http request]({{< relref "20220209102028.md#pcoll-pattern-in-clojure-http-request" >}})

é–¢æ•°å‘¼ã³å‡ºã—ã®ãƒ©ãƒƒãƒ‘ãƒ¼é–¢æ•°ã‚’ä½œæˆã™ã‚‹ã®ã¯ã‚ˆãè¦‹ã‹ã‘ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³. ã•ã‚‰ã«ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã¨ã—ã¦çµ„ã¿è¾¼ã‚“ã ã‚Š. pcallã¨ã„ã†ã‚ˆã‚Šã‚‚wrapã¨ã‹middlewareã¨ã‹handlerã¨ã„ã†ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¨ã¨ã‚‚ã«ç¾ã‚Œã‚‹ã“ã¨ãŒå¤šã„ã‹ã‚‚. pcallã®procedure callã¯handler wrapper.

-   [Part6: TODO ã‚¢ãƒ—ãƒªã‚’çµ„ã¿ä¸Šã’ã‚‹ â€” ã‚¨ãƒ©ãƒ¼ã‚’ã†ã¾ãå‡¦ç†ã™ã‚‹](https://ayato-p.github.io/clojure-beginner/intro_web_development/part6_build_up_our_app.html#id12)
    -   slingshotã‚’ã¤ã‹ã£ãŸãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä¾‹(ja).
-   [Ringã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ä¾‹å¤–ã‚’ã„ã„æ„Ÿã˜ã«ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã™ã‚‹æ–¹æ³•(Ductã§ã®è§£èª¬ã‚‚å«ã‚€) - Uzabase for Engineers](https://tech.uzabase.com/entry/2019/10/07/190000)
-   [Handling Exceptions with Middleware in Clojure | 8th Light](https://8thlight.com/blog/mike-knepper/2015/05/19/handling-exceptions-with-middleware-in-clojure.html)
    -   wrap-exceptionã¨ã„ã†ã‚«ã‚¹ã‚¿ãƒ wrapperã¨ [ring-json]({{< relref "20220118092453.md#ring-json-middleware" >}}) ã®çµ„ã¿åˆã‚ã›.


## <span class="org-todo todo _">ğŸ”—</span> References {#references}

-
