+++
title = "ğŸ“Clojure spec"
tags = ["WIKI"]
draft = false
+++

up: [ğŸ“‚Clojure Core Languages]({{< relref "20220112142936.md" >}})


## clojure.specã¨ã¯ {#clojure-dot-specã¨ã¯}

Clojureã«ãŠã„ã¦ [å¥‘ç´„ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°]({{< relref "20220323034550.md" >}}) ã‚’å®Ÿæ–½ã™ã‚‹ãŸã‚ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒª.

Clojure 1.9ã‹ã‚‰å°å…¥ã•ã‚ŒãŸ.
ã“ã‚Œã¯ [2017.12](https://clojure.org/news/2017/12/08/clojure19) ã®è©±ãªã®ã§å¤ã„æ›¸ç±ã ã¨ãã‚‚ãã‚‚clojure.specã®è©±é¡Œã‚’æ‰±ã£ã¦ã„ãªã„.


## clojure.spec Usages {#clojure-dot-spec-usages}


### Basics {#basics}

-   s/def
    -   æº€ãŸã™ã¹ãæ¡ä»¶ã‚’å®£è¨€
-   s/valid?
    -   æ¡ä»¶ã‚’æ¤œè¨¼
-   s/coll-of
    -   æ¡ä»¶ã‚’æº€ãŸã™é›†åˆã‚’å®£è¨€
-   s/keys
    -   æ¡ä»¶ã‚’æº€ãŸã™åå‰ä»˜ãã®å€¤ã®é›†åˆ(ie. Map)ã®æ¡ä»¶ã‚’å®šç¾©
    -   :reqã¯å¿…é ˆã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰, :optã¯ä»»æ„ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰.
-   s/explain
    -   æ¤œè¨¼ãŒå¤±æ•—ã—ãŸç†ç”±ã‚’å‡ºåŠ›.
-   s/conform
    -   æ¡ä»¶ã‚’æº€ãŸã™å ´åˆã®ã¿ä¸ãˆã‚‰ã‚ŒãŸå€¤ã‚’æ¤œè¨¼ã‚’é€šéã—ãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«æŸç¸›.
-   s/cat
    -   æŸç¸›ã•ã‚Œã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¨ãã®æ¡ä»¶ã‚’ã¾ã¨ã‚ã‚‹ã¨ã„ã†å®£è¨€.

---

ä»¥ä¸‹ã®è¨˜äº‹ã‚’å‚è€ƒ.

[What Clojure spec is and what you can do with it - Pixelated Noise Blog](https://www.pixelated-noise.com/blog/2020/09/10/what-spec-is/)

```clojure
(require '[clojure.spec.alpha :as s])

;; basic
;; s/defã§æº€ãŸã™ã¹ãæ¡ä»¶ã‚’å®£è¨€
;; s/valid? ã§æ¤œè¨¼
(s/def ::username string?)
(s/valid? ::username "foo")
(s/valid? #(> % 5) 10)

;; collections
;; s/coll-ofã§æ¡ä»¶ã‚’æº€ãŸã™é›†åˆã‚’å®£è¨€
(s/def ::usernames (s/coll-of ::username))
(s/valid? ::usernames ["foo" "bar" "baz"])

;; Maps
;; s/keysã§æ¡ä»¶ã‚’æº€ãŸã™åå‰ä»˜ãã®å€¤ã®é›†åˆ(ie. Map)ã®æ¡ä»¶ã‚’å®šç¾©
;; :reqã¯å¿…é ˆã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰, :optã¯ä»»æ„ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰.
(s/def ::password string?)
(s/def ::last-login number?)
(s/def ::comment string?)
(s/def ::user
  (s/keys
   :req [::username ::password]
   :opt [::comment ::last-login]))
(s/valid?
 ::user
 {::username   "rich"
  ::password   "zegure"
  ::comment    "this is a user"
  ::last-login 11000})

;; Explain
;; s/explainã§æ¤œè¨¼ãŒå¤±æ•—ã—ãŸç†ç”±ã‚’å‡ºåŠ›.
(s/explain
 ::user
 {::username "rich"
  ::comment  "this is a user"})
```


### s/def: ãƒ«ãƒ¼ãƒ«ã‚’å®šç¾©ã™ã‚‹ {#s-def-ãƒ«ãƒ¼ãƒ«ã‚’å®šç¾©ã™ã‚‹}

s/defã§æŒ‡å®šã™ã‚‹keywordã¯ ::hogeã‹ :foo/barã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚‹.

> k must be namespaced keyword or resolvable symbol (c/and (ident? k) (namespace k))

è¨€ã„æ›ãˆã‚‹ã¨ :fooã®ã‚ˆã†ãªnamespaceã‹ã‚‰å§‹ã¾ã‚‹slashã‚’ä¼´ã‚ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã™ã‚‹.


### clojure.spec conform {#clojure-dot-spec-conform}

ã„ã‚ã°æ­£è¦è¡¨ç¾ã®ã‚ˆã†ãª, åˆ†é…æŸç¸›ã®ã‚ˆã†ãªæ©Ÿèƒ½ã‚’æä¾›ã™ã‚‹.

Clojure specã®å¼·åŠ›ãªæ©Ÿèƒ½ã®ã²ã¨ã¤.

-   s/conform
    -   æ¡ä»¶ã‚’æº€ãŸã™å ´åˆã®ã¿ä¸ãˆã‚‰ã‚ŒãŸå€¤ã‚’æ¤œè¨¼ã‚’é€šéã—ãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«æŸç¸›.
-   s/cat
    -   æŸç¸›ã•ã‚Œã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¨ãã®æ¡ä»¶ã‚’ã¾ã¨ã‚ã‚‹ã¨ã„ã†å®£è¨€.

<!--listend-->

```clojure
(s/def ::ingredient (s/cat :quantity number? :unit keyword?))
(s/conform ::ingredient [2 :teaspoon])
;; => {:quantity 2, :unit :teaspoon}
```


### clojure.spec: s/fdef {#clojure-dot-spec-s-fdef}

é–¢æ•°ã¨ã„ã†ã‚‚ã®ãŒ[:defn :name :doc :args :body]ã®5ã¤ã®ã‚­ãƒ¼ã«æŸç¸›ã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã®é›†åˆã¨ã¿ãªã›ã°ãã‚Œã‚‰ã«å¯¾ã™ã‚‹æ¤œè¨¼ã‚’ã™ã‚‹ã“ã¨ã§é–¢æ•°ãŒæ¤œè¨¼ã§ãã‚‹, ã¨ã„ã†è€ƒãˆæ–¹.

```clojure
(s/def ::function (s/cat :defn #{'defn}
                         :name symbol?
                         :doc (s/? string?)
                         :args vector?
                         :body (s/+ list?)))
```

ã‚ã‚‹namespace **foo** ã§ **s/def** ã§ **::foo-x** ã¨å®šç¾©ã—ãŸã‚‚ã®ã‚’åˆ¥ã®namespaceã‹ã‚‰ä½¿ã†å ´åˆã¯ **::foo/foo-x** ã¨ãªã‚‹.

```clojure
(ns foo.core
  (:requre [clojure.spec.alpha :as s]))
(s/def ::foo-x pos?)

(ns bar.core
  (:requre [clojure.spec.alpha :as s]
           [foo.core :as foo]))
(s/valid? ::foo/foo-x 1)
```


### clojure.spec Instrument {#clojure-dot-spec-instrument}

clojure.spec.test.alpha/instrumentã¨ã„ã†é–¢æ•°ã‚’å®Ÿè¡Œã™ã‚‹ã¨ãã®å¾Œã«specã‚’å®šç¾©ã—ã¦ã‚ã‚‹é–¢æ•°ã‚’å®Ÿè¡Œã™ã‚‹ãŸã³ã«specé€šã‚Šã®å¼•æ•°ã‚„æˆ»ã‚Šå€¤ã«ãªã£ã¦ã„ã‚‹ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã‚Œã‚‹.

ref: [Instrument - spec Guide](https://clojure.org/guides/spec#_instrumentation)


## clojure.specã«ã‚ˆã‚‹é˜²è¡›çš„ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚° {#clojure-dot-specã«ã‚ˆã‚‹é˜²è¡›çš„ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°}

ref: [ğŸ“Clojure Architecture]({{< relref "20220314120812.md" >}})

-   é˜²è¡›çš„ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°(Secure Programming)
-   ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚·ã‚¹ãƒ†ãƒ (Contract System)

ç°¡å˜ã«å¼•æ•°ãƒã‚§ãƒƒã‚¯ã‚’ã™ã‚‹ã‚‰ã°, Clojureã®Special Formã®(:pre, :post)ã®åˆ©ç”¨ã‚‚ã§ãã‚‹.

ref. [Clojure - Special Forms](https://clojure.org/reference/special_forms#_fn_name_param_condition_map_expr_2)

```clojure
(defn constrained-sqr [x]
    {:pre  [(pos? x)]
     :post [(> % 16), (< % 225)]}
    (* x x))
```

ã‚‚ã—ãã¯predicatesã®éƒ¨åˆ†ã ã‘clojure.specã‚’ã¤ã‹ã†.

```clojure
(s/def ::x pos?)
(defn constrained-sqr2 [x]
  {:pre [(s/valid? ::x x)]}
  (* x x))
```

**s/assert** ã§ä¸­èº«ã‚’ãƒã‚§ãƒƒã‚¯ã—ãŸçµæœã‚’letã§bindã—ã¦ã‚‚ã„ã„. ã“ã®ã¨ã **s/conform** ã‚’åˆ©ç”¨ã™ã‚‹ã¨ä¾‹å¤–ãŒä¸ŠãŒã‚‰ãšã« **:clojure.spec.alpha.invalid** ãŒbindingã•ã‚Œã¦å‡¦ç†ãŒç¶™ç¶šã™ã‚‹ã®ã§æ³¨æ„.

è©³ã—ãã¯ã“ã¡ã‚‰ -> [Using spec for validateion - clojure.org](https://clojure.org/guides/spec#_using_spec_for_validation)

clojure.orgã«ã‚‚ã‚ã‚‹ã‚ˆã†ã«æ°—è»½ãªå¼•æ•°ãƒã‚§ãƒƒã‚¯ãªã‚‰preã§ã‚‚ã„ã„ãŒ, ã‚¬ãƒã‚ŠãŸã„å ´åˆã¯sdefã‚’å°å…¥ã™ã‚‹ã“ã¨.


## ğŸ’¡clojure.specã¯ Schemaã§ã¯ãªã„ {#clojure-dot-specã¯-schemaã§ã¯ãªã„}

[Eric Normand]({{< relref "20220324214106.md" >}}) ã•ã‚“ã®ä»¥ä¸‹ã®è¨˜äº‹ã‚ˆã‚Š.

[5 Differences between clojure.spec and Schema](https://ericnormand.me/mini-guide/clojure-spec-vs-schema)

clojure.spceã‚‚Schemaã‚‚åŒã˜èª²é¡Œã‚’è§£æ±ºã—ã‚ˆã†ã¨ã—ãŸç‚¹ã§ä¼¼ã¦ã„ã‚‹.
ã—ã‹ã—ä¸¡è€…ã¯æœ¬è³ªçš„ã«åˆ¥ã®ã‚‚ã®ã§ã‚ã‚‹.

-   clojure.specã¯ "Data DSL"ã§ã¯ãªã„.
-   clojure.specã¯ namespaced keywrodsã‚’å¥½ã‚€.
-   clojure.specã¯å¼·åŠ›ãªã‚·ãƒ¼ã‚±ãƒ³ã‚¹æ¤œè¨¼æ©Ÿèƒ½ãŒã‚ã‚‹.
-   clojure.specã¯æ¤œè¨¼(checking)ã¨ãƒ‘ãƒ¼ã‚¹(parsing)ã‚’å…¼ã­å‚™ãˆã‚‹(conform).
-   clojure.specã¯test.checkã¨ã®å¼·ã„é€£æºãŒã‚ã‚‹.


## clojure.specã¨å‹ãƒ’ãƒ³ãƒˆã¨ã®æ¯”è¼ƒ {#clojure-dot-specã¨å‹ãƒ’ãƒ³ãƒˆã¨ã®æ¯”è¼ƒ}

ref: ğŸ“[Clojure: å‹ãƒ’ãƒ³ãƒˆ(Type Hinting)]({{< relref "20220117172324.md#clojure-å‹ãƒ’ãƒ³ãƒˆ--type-hinting" >}})


## References {#references}

-   [GitHub - clojure/spec.alpha](https://github.com/clojure/spec.alpha)
-   [Clojure - spec Guide](https://clojure.org/guides/spec)
    -   å…¬å¼Reference
-   [Clojure - clojure.spec - è«–ç†çš„æ ¹æ‹ ã¨æ¦‚è¦](https://japan-clojurians.github.io/clojure-site-ja/about/spec.html)
-   [Everyday Life with clojure.spec](https://www.slideshare.net/KentOhashi/everydaylifewithclojurespec)
-   [clojure.specã‚’é–‹ç™ºã‚„ãƒ†ã‚¹ãƒˆã§æ´»ç”¨ã™ã‚‹ - ayato-p](https://scrapbox.io/ayato-p/clojure.spec%E3%82%92%E9%96%8B%E7%99%BA%E3%82%84%E3%83%86%E3%82%B9%E3%83%88%E3%81%A7%E6%B4%BB%E7%94%A8%E3%81%99%E3%82%8B)
-   [Clojureã§å …ç‰¢ãªã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã ï½œhdenï½œnote](https://note.com/hden/n/n708bae6cbdc6)
